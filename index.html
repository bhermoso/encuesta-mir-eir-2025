<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Encuesta MIR/EIR - Promoci√≥n de la Salud</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-database-compat.js"></script>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        :root {
            --primary: #1a365d;
            --primary-light: #2c5282;
            --accent: #4299e1;
            --success: #38a169;
            --warning: #d69e2e;
            --danger: #e53e3e;
            --bg: #f0f4f8;
            --card: #ffffff;
            --text: #2d3748;
            --text-light: #718096;
        }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        
        /* Header */
        .header { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); color: white; padding: 18px 25px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .header h1 { font-size: 1.4em; display: flex; align-items: center; gap: 10px; }
        .header-stats { display: flex; gap: 20px; }
        .header-stat { text-align: center; }
        .header-stat .number { font-size: 1.8em; font-weight: 700; }
        .header-stat .label { font-size: 0.75em; opacity: 0.9; }
        
        /* Nav */
        .nav { background: var(--card); padding: 12px 25px; display: flex; gap: 8px; flex-wrap: wrap; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .nav-btn { padding: 10px 22px; border: none; border-radius: 25px; font-size: 0.9em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 8px; }
        .nav-btn.primary { background: linear-gradient(135deg, var(--primary), var(--primary-light)); color: white; }
        .nav-btn.secondary { background: var(--bg); color: var(--primary); }
        .nav-btn.success { background: linear-gradient(135deg, #276749, var(--success)); color: white; }
        .nav-btn:hover { transform: translateY(-2px); }
        .nav-btn.active { box-shadow: inset 0 2px 5px rgba(0,0,0,0.2); }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .view { display: none; }
        .view.active { display: block; }
        
        .card { background: var(--card); border-radius: 16px; padding: 22px; margin-bottom: 18px; box-shadow: 0 4px 20px rgba(0,0,0,0.08); }
        .card h2 { color: var(--primary); margin-bottom: 18px; display: flex; align-items: center; gap: 10px; font-size: 1.15em; }
        
        /* Session */
        .session-controls { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 18px; }
        .session-btn { padding: 14px 26px; border: none; border-radius: 12px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; display: flex; align-items: center; gap: 10px; }
        .session-btn.start { background: linear-gradient(135deg, #276749, var(--success)); color: white; }
        .session-btn.stop { background: linear-gradient(135deg, #c53030, var(--danger)); color: white; }
        .session-btn.reset { background: var(--bg); color: var(--text); }
        .session-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .session-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        
        .session-status { display: flex; align-items: center; gap: 10px; padding: 14px 20px; border-radius: 12px; margin-bottom: 18px; font-weight: 500; }
        .session-status.active { background: #c6f6d5; color: #276749; }
        .session-status.inactive { background: #fed7d7; color: #c53030; }
        .session-status.waiting { background: #fefcbf; color: #975a16; }
        .status-dot { width: 12px; height: 12px; border-radius: 50%; }
        .session-status.active .status-dot { background: #38a169; animation: pulse 1.5s infinite; }
        .session-status.inactive .status-dot { background: #e53e3e; }
        .session-status.waiting .status-dot { background: #d69e2e; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* QR */
        .qr-section { text-align: center; padding: 25px; }
        .qr-container { display: inline-block; padding: 20px; background: white; border-radius: 16px; box-shadow: 0 8px 30px rgba(0,0,0,0.12); margin: 15px 0; }
        .qr-url { margin-top: 15px; padding: 12px 18px; background: var(--bg); border-radius: 10px; font-family: monospace; font-size: 0.8em; word-break: break-all; }
        .qr-instructions { margin-top: 20px; color: var(--text-light); line-height: 1.6; font-size: 0.9em; }
        
        /* Grid */
        .monitor-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 18px; }
        
        /* Progress Ring */
        .progress-ring-container { text-align: center; padding: 15px; }
        .progress-ring { width: 150px; height: 150px; margin: 0 auto; }
        .progress-ring-text { font-size: 2em; font-weight: 700; fill: var(--primary); }
        .progress-ring-label { font-size: 0.8em; fill: var(--text-light); }
        
        /* Stats */
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; }
        .stat-mini { background: var(--bg); border-radius: 10px; padding: 15px 10px; text-align: center; }
        .stat-mini .icon { font-size: 1.4em; margin-bottom: 5px; }
        .stat-mini .value { font-size: 1.5em; font-weight: 700; color: var(--primary); }
        .stat-mini .label { font-size: 0.7em; color: var(--text-light); margin-top: 3px; }
        
        /* Live Feed */
        .live-feed { max-height: 320px; overflow-y: auto; }
        .live-item { display: flex; align-items: center; gap: 12px; padding: 10px; margin: 6px 0; background: var(--bg); border-radius: 10px; animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .live-item .icon { width: 38px; height: 38px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.1em; }
        .live-item .icon.mir { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .live-item .icon.eir { background: linear-gradient(135deg, #c05621, #ed8936); color: white; }
        .live-item .info { flex: 1; }
        .live-item .info .name { font-weight: 600; font-size: 0.95em; }
        .live-item .info .meta { font-size: 0.8em; color: var(--text-light); }
        .live-item .time { font-size: 0.75em; color: var(--text-light); }
        
        /* Dist Bars */
        .dist-section h4 { font-size: 0.9em; margin-bottom: 8px; }
        .dist-item { margin: 8px 0; }
        .dist-label { display: flex; justify-content: space-between; margin-bottom: 4px; font-size: 0.85em; }
        .dist-bar { height: 20px; background: #e2e8f0; border-radius: 10px; overflow: hidden; }
        .dist-fill { height: 100%; border-radius: 10px; transition: width 0.5s ease; min-width: 25px; display: flex; align-items: center; padding-left: 8px; }
        .dist-fill span { color: white; font-size: 0.7em; font-weight: 600; }
        
        /* Results Tabs */
        .results-tabs { display: flex; gap: 6px; margin-bottom: 18px; flex-wrap: wrap; }
        .results-tab { padding: 10px 18px; border: none; background: var(--bg); border-radius: 20px; cursor: pointer; font-weight: 500; font-size: 0.9em; transition: all 0.3s; }
        .results-tab:hover { background: #e2e8f0; }
        .results-tab.active { background: var(--primary); color: white; }
        .results-content { display: none; }
        .results-content.active { display: block; }
        
        /* Gauge */
        .gauge-row { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .gauge-item { text-align: center; padding: 15px; }
        .gauge-svg { width: 110px; height: 65px; }
        .gauge-value { font-size: 1.5em; font-weight: 700; color: var(--primary); margin-top: 5px; }
        .gauge-label { font-size: 0.75em; color: var(--text-light); margin-top: 5px; }
        
        /* Lollipop */
        .lollipop-item { display: flex; align-items: center; margin: 10px 0; }
        .lollipop-label { width: 140px; font-size: 0.8em; color: var(--text); }
        .lollipop-track { flex: 1; height: 4px; background: #e2e8f0; border-radius: 2px; position: relative; margin: 0 8px; }
        .lollipop-line { height: 4px; border-radius: 2px; position: absolute; left: 0; transition: width 0.5s; }
        .lollipop-dot { width: 24px; height: 24px; border-radius: 50%; position: absolute; top: 50%; transform: translateY(-50%); display: flex; align-items: center; justify-content: center; color: white; font-size: 0.6em; font-weight: 700; box-shadow: 0 2px 6px rgba(0,0,0,0.2); transition: left 0.5s; }
        
        /* Collab Grid */
        .collab-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .collab-item { background: var(--bg); border-radius: 10px; padding: 12px 8px; text-align: center; transition: all 0.3s; }
        .collab-item.high { background: #ebf8ff; border: 2px solid var(--accent); }
        .collab-item .icon { font-size: 1.5em; margin-bottom: 5px; }
        .collab-item .name { font-size: 0.65em; color: var(--text-light); margin-bottom: 4px; line-height: 1.2; }
        .collab-item .pct { font-size: 1.1em; font-weight: 700; color: var(--primary); }
        
        /* Ranking */
        .ranking-item { display: flex; align-items: center; padding: 12px; margin: 8px 0; background: var(--bg); border-radius: 10px; }
        .ranking-item .pos { width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 0.85em; margin-right: 12px; background: var(--primary); color: white; }
        .ranking-item:nth-child(1) .pos { background: linear-gradient(135deg, #d69e2e, #f6e05e); }
        .ranking-item:nth-child(2) .pos { background: linear-gradient(135deg, #718096, #a0aec0); }
        .ranking-item:nth-child(3) .pos { background: linear-gradient(135deg, #c05621, #ed8936); }
        .ranking-item .icon { font-size: 1.3em; margin-right: 10px; }
        .ranking-item .text { flex: 1; font-size: 0.9em; }
        .ranking-item .value { font-size: 1.2em; font-weight: 700; color: var(--primary); }
        
        /* Pictogram */
        .pictogram { display: flex; flex-wrap: wrap; gap: 3px; margin: 15px 0; justify-content: center; }
        .pictogram-icon { font-size: 1.2em; }
        .pictogram-legend { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; margin-top: 10px; font-size: 0.85em; }
        .pictogram-legend-item { display: flex; align-items: center; gap: 5px; }
        
        /* Waffle */
        .waffle { display: grid; grid-template-columns: repeat(10, 1fr); gap: 3px; max-width: 250px; margin: 15px auto; }
        .waffle-cell { aspect-ratio: 1; border-radius: 3px; }
        .waffle-legend { display: flex; justify-content: center; gap: 20px; margin-top: 10px; font-size: 0.85em; }
        .waffle-legend-item { display: flex; align-items: center; gap: 6px; }
        .waffle-legend-color { width: 14px; height: 14px; border-radius: 3px; }
        
        /* Survey Mode */
        .survey-mode { background: linear-gradient(135deg, var(--primary) 0%, var(--primary-light) 100%); min-height: 100vh; }
        .survey-mode .header { background: transparent; box-shadow: none; }
        .survey-container { max-width: 700px; margin: 0 auto; padding: 20px; }
        .survey-card { background: white; border-radius: 20px; padding: 30px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }
        .survey-progress { background: #e2e8f0; height: 6px; border-radius: 3px; margin-bottom: 25px; overflow: hidden; }
        .survey-progress-fill { height: 100%; background: linear-gradient(90deg, var(--primary), var(--accent)); transition: width 0.3s; }
        .survey-section h3 { color: var(--primary); margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid var(--bg); font-size: 1.2em; }
        .survey-question { margin-bottom: 22px; }
        .survey-question > label { display: block; margin-bottom: 10px; font-weight: 500; color: var(--text); }
        .radio-group, .checkbox-group { display: flex; flex-direction: column; gap: 8px; }
        .radio-option, .checkbox-option { display: flex; align-items: center; gap: 10px; padding: 12px 15px; background: var(--bg); border-radius: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .radio-option:hover, .checkbox-option:hover { background: #e2e8f0; }
        .radio-option.selected, .checkbox-option.selected { background: #ebf8ff; border-color: var(--accent); }
        .radio-option input, .checkbox-option input { position: absolute; opacity: 0; width: 0; height: 0; }
        .checkbox-option::before { content: ''; }
        .likert-scale { display: flex; gap: 8px; flex-wrap: wrap; }
        .likert-option { flex: 1; min-width: 60px; text-align: center; padding: 12px 6px; background: var(--bg); border-radius: 10px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
        .likert-option:hover { background: #e2e8f0; }
        .likert-option.selected { background: var(--primary); color: white; border-color: var(--primary); }
        .likert-option .number { font-size: 1.3em; font-weight: 700; }
        .likert-option .text { font-size: 0.6em; margin-top: 4px; }
        select.survey-select { width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0; border-radius: 10px; font-size: 1em; background: white; }
        .survey-nav { display: flex; justify-content: space-between; margin-top: 25px; padding-top: 20px; border-top: 2px solid var(--bg); }
        .survey-btn { padding: 12px 28px; border: none; border-radius: 25px; font-size: 1em; font-weight: 600; cursor: pointer; transition: all 0.3s; }
        .survey-btn.next { background: var(--primary); color: white; }
        .survey-btn.prev { background: var(--bg); color: var(--text); }
        .survey-btn.submit { background: var(--success); color: white; }
        .survey-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 15px rgba(0,0,0,0.15); }
        .survey-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .survey-complete { text-align: center; padding: 50px 20px; }
        .survey-complete .icon { font-size: 4em; margin-bottom: 20px; }
        .survey-complete h2 { color: var(--success); margin-bottom: 10px; }
        .survey-complete p { color: var(--text-light); }
        
        .matrix-container { overflow-x: auto; }
        .matrix-table { width: 100%; border-collapse: collapse; }
        .matrix-table th { padding: 8px 5px; font-size: 0.65em; color: var(--text-light); font-weight: 500; }
        .matrix-table td { padding: 8px 5px; text-align: center; }
        .matrix-table td:first-child { text-align: left; font-size: 0.85em; padding-right: 10px; min-width: 150px; }
        .matrix-table tr:nth-child(even) { background: var(--bg); }
        .matrix-radio { width: 20px; height: 20px; cursor: pointer; accent-color: var(--primary); }
        
        .hidden { display: none !important; }
        
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 12px; text-align: center; padding: 15px; }
            .header h1 { font-size: 1.2em; }
            .header-stats { gap: 15px; }
            .nav { justify-content: center; padding: 10px 15px; }
            .nav-btn { padding: 8px 16px; font-size: 0.85em; }
            .container { padding: 15px; }
            .monitor-grid { grid-template-columns: 1fr; }
            .stats-row { grid-template-columns: repeat(2, 1fr); }
            .lollipop-label { width: 100px; font-size: 0.7em; }
            .survey-card { padding: 20px; }
            .likert-option { min-width: 50px; padding: 10px 4px; }
            .likert-option .number { font-size: 1.1em; }
        }
    </style>
</head>
<body>
    <!-- MODO PANEL -->
    <div id="panelMode">
        <div class="header">
            <h1>üìä Encuesta MIR/EIR ¬∑ Promoci√≥n de la Salud</h1>
            <div class="header-stats">
                <div class="header-stat"><div class="number" id="headerTotal">0</div><div class="label">Respuestas</div></div>
                <div class="header-stat"><div class="number" id="headerMir">0</div><div class="label">MIR</div></div>
                <div class="header-stat"><div class="number" id="headerEir">0</div><div class="label">EIR</div></div>
            </div>
        </div>
        
        <div class="nav">
            <button class="nav-btn primary active" onclick="showView('panel')" id="btnPanel">üñ•Ô∏è Panel</button>
            <button class="nav-btn success" onclick="showView('resultados')" id="btnResultados">üìä Resultados</button>
            <button class="nav-btn secondary" onclick="exportData()">üì• Exportar CSV</button>
            <button class="nav-btn secondary" onclick="generarPDF()">üìÑ PDF Cuestionario</button>
        </div>
        
        <div class="container">
            <div class="view active" id="viewPanel">
                <div class="session-controls">
                    <button class="session-btn start" id="btnStartSession" onclick="startSession()">‚ñ∂Ô∏è Iniciar Sesi√≥n</button>
                    <button class="session-btn stop" id="btnStopSession" onclick="stopSession()" disabled>‚èπÔ∏è Cerrar</button>
                    <button class="session-btn reset" onclick="resetSession()">üîÑ Reiniciar</button>
                    <button class="session-btn" style="background:linear-gradient(135deg,#805ad5,#9f7aea);color:white" onclick="simularDatos()">üß™ Simular 100</button>
                </div>
                
                <div class="session-status waiting" id="sessionStatus">
                    <div class="status-dot"></div>
                    <span id="sessionStatusText">Pulsa "Iniciar Sesi√≥n" para comenzar</span>
                </div>
                
                <div class="session-status" id="firebaseStatus" style="background:#fefcbf;color:#975a16">
                    <div class="status-dot" style="background:#d69e2e"></div>
                    <span id="firebaseStatusText">üî• Verificando conexi√≥n a Firebase...</span>
                </div>
                
                <div class="monitor-grid">
                    <div class="card qr-section">
                        <h2>üì± C√≥digo QR</h2>
                        <div class="qr-container" id="qrcode"><div style="width:200px;height:200px;background:#f0f4f8;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#718096;font-size:3em">üì±</div></div>
                        <div class="qr-url" id="surveyUrl">El enlace aparecer√° aqu√≠</div>
                        <div class="qr-instructions"><strong>Instrucciones:</strong><br>1. Inicia sesi√≥n ¬∑ 2. Proyecta el QR ¬∑ 3. Participantes escanean y rellenan</div>
                    </div>
                    
                    <div class="card">
                        <h2>üìà Progreso</h2>
                        <div class="progress-ring-container">
                            <svg class="progress-ring" viewBox="0 0 100 100">
                                <circle cx="50" cy="50" r="42" fill="none" stroke="#e2e8f0" stroke-width="8"/>
                                <circle id="progressCircle" cx="50" cy="50" r="42" fill="none" stroke="url(#grad)" stroke-width="8" stroke-linecap="round" stroke-dasharray="264" stroke-dashoffset="264" transform="rotate(-90 50 50)"/>
                                <defs><linearGradient id="grad"><stop offset="0%" stop-color="#2c5282"/><stop offset="100%" stop-color="#4299e1"/></linearGradient></defs>
                                <text x="50" y="46" class="progress-ring-text" text-anchor="middle" id="progressPercent">0%</text>
                                <text x="50" y="62" class="progress-ring-label" text-anchor="middle" id="progressCount">0 / 100</text>
                            </svg>
                        </div>
                        <div class="stats-row">
                            <div class="stat-mini"><div class="icon">ü©∫</div><div class="value" id="statMir">0</div><div class="label">MIR</div></div>
                            <div class="stat-mini"><div class="icon">üíâ</div><div class="value" id="statEir">0</div><div class="label">EIR</div></div>
                            <div class="stat-mini"><div class="icon">üèõÔ∏è</div><div class="value" id="statGranada">0</div><div class="label">Granada</div></div>
                            <div class="stat-mini"><div class="icon">üèòÔ∏è</div><div class="value" id="statMetro">0</div><div class="label">Metro</div></div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2>üî¥ En Vivo</h2>
                        <div class="live-feed" id="liveFeed"><div style="text-align:center;color:var(--text-light);padding:40px">Esperando respuestas...</div></div>
                    </div>
                    
                    <div class="card">
                        <h2>üìä Por A√±o</h2>
                        <div class="dist-section">
                            <h4 style="color:var(--primary)">MIR</h4>
                            <div class="dist-item"><div class="dist-label"><span>R1</span><span id="mirR1">0</span></div><div class="dist-bar"><div class="dist-fill" id="mirR1Bar" style="width:0%;background:var(--primary)"><span></span></div></div></div>
                            <div class="dist-item"><div class="dist-label"><span>R2</span><span id="mirR2">0</span></div><div class="dist-bar"><div class="dist-fill" id="mirR2Bar" style="width:0%;background:var(--primary)"><span></span></div></div></div>
                            <div class="dist-item"><div class="dist-label"><span>R3</span><span id="mirR3">0</span></div><div class="dist-bar"><div class="dist-fill" id="mirR3Bar" style="width:0%;background:var(--primary)"><span></span></div></div></div>
                            <div class="dist-item"><div class="dist-label"><span>R4</span><span id="mirR4">0</span></div><div class="dist-bar"><div class="dist-fill" id="mirR4Bar" style="width:0%;background:var(--primary)"><span></span></div></div></div>
                            <h4 style="color:#ed8936;margin-top:15px">EIR</h4>
                            <div class="dist-item"><div class="dist-label"><span>R1</span><span id="eirR1">0</span></div><div class="dist-bar"><div class="dist-fill" id="eirR1Bar" style="width:0%;background:#ed8936"><span></span></div></div></div>
                            <div class="dist-item"><div class="dist-label"><span>R2</span><span id="eirR2">0</span></div><div class="dist-bar"><div class="dist-fill" id="eirR2Bar" style="width:0%;background:#ed8936"><span></span></div></div></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="view" id="viewResultados">
                <div class="results-tabs">
                    <button class="results-tab active" onclick="showResultsTab('resumen')">üìã Resumen</button>
                    <button class="results-tab" onclick="showResultsTab('perfil')">üë• Perfil</button>
                    <button class="results-tab" onclick="showResultsTab('comparativa')">üìä MIR vs EIR</button>
                    <button class="results-tab" onclick="showResultsTab('sexo')">üë©‚Äç‚öïÔ∏è Por Sexo</button>
                    <button class="results-tab" onclick="showResultsTab('promotor')">üèÜ Promotor Activo</button>
                    <button class="results-tab" onclick="showResultsTab('formacion')">üìö Formaci√≥n</button>
                    <button class="results-tab" onclick="showResultsTab('elementos')">‚öôÔ∏è Condiciones</button>
                    <button class="results-tab" onclick="showResultsTab('diagnostico')">üî¨ Diagn√≥stico</button>
                    <button class="results-tab" onclick="showResultsTab('colaboracion')">ü§ù Colaboraci√≥n</button>
                    <button class="results-tab" onclick="showResultsTab('epvsa')">üéØ Objetivos EPVSA</button>
                </div>
                <div class="results-content active" id="resultsResumen"></div>
                <div class="results-content" id="resultsPerfil"></div>
                <div class="results-content" id="resultsComparativa"></div>
                <div class="results-content" id="resultsSexo"></div>
                <div class="results-content" id="resultsPromotor"></div>
                <div class="results-content" id="resultsFormacion"></div>
                <div class="results-content" id="resultsElementos"></div>
                <div class="results-content" id="resultsDiagnostico"></div>
                <div class="results-content" id="resultsColaboracion"></div>
                <div class="results-content" id="resultsEpvsa"></div>
            </div>
        </div>
    </div>
    
    <!-- MODO ENCUESTA -->
    <div id="surveyMode" class="survey-mode hidden">
        <div class="header">
            <h1>üìä Encuesta MIR/EIR</h1>
        </div>
        <div class="survey-container">
            <div class="survey-card">
                <div class="survey-progress"><div class="survey-progress-fill" id="surveyProgressBar" style="width:0%"></div></div>
                <div id="surveyContent"></div>
            </div>
        </div>
    </div>

<script>
// ==================== FIREBASE ====================
const firebaseConfig = {
    apiKey: "AIzaSyB2goG1BRWeN9KdCE-DtrikfQ-mHtFCcpI",
    authDomain: "encuesta-mir-eir.firebaseapp.com",
    databaseURL: "https://encuesta-mir-eir-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "encuesta-mir-eir",
    storageBucket: "encuesta-mir-eir.firebasestorage.app",
    messagingSenderId: "948289575092",
    appId: "1:948289575092:web:7f5802f0ff45e6cf72dfe1"
};

// ==================== ESTADO ====================
let db = null;
let sessionActive = false;
let sessionId = null;
let responses = [];
const TARGET = 100;

const LABELS = {
    sexo: { 1: 'Hombre', 2: 'Mujer', 3: 'Otro', 4: 'Prefiero no contestar' },
    sexo_icon: { 1: 'üë®', 2: 'üë©', 3: 'üßë', 4: '‚ùì' },
    sexo_color: { 1: '#2c5282', 2: '#e53e3e', 3: '#805ad5', 4: '#718096' },
    tipo_residente: { 1: 'MIR (Medicina familiar y comunitaria)', 2: 'EIR (Enfermer√≠a familiar y comunitaria)' },
    anio_mir: { 1: 'R1 (Primer a√±o)', 2: 'R2 (Segundo a√±o)', 3: 'R3 (Tercer a√±o)', 4: 'R4 (Cuarto a√±o)' },
    anio_eir: { 1: 'R1 (Primer a√±o)', 2: 'R2 (Segundo a√±o)' },
    distrito: { 0: 'Granada', 1: 'Metropolitano de Granada' },
    modalidad: { 1: 'Presencial', 2: 'Online', 3: 'Mixta (presencial y online)' },
    modalidad_icon: { 1: 'üè´', 2: 'üíª', 3: 'üîÑ' },
    tematicas_formacion: { 1: 'Dise√±o, planificaci√≥n y evaluaci√≥n de intervenciones de promoci√≥n de la salud', 2: 'Competencias y habilidades para la intervenci√≥n grupal en promoci√≥n de la salud', 3: 'Estrategias, planes y programas de promoci√≥n de la salud en mi centro', 4: 'M√©todos y t√©cnicas cuantitativas y cualitativas de investigaci√≥n, participaci√≥n y acci√≥n en promoci√≥n de la salud', 5: 'Otras' },
    disponibilidad_horaria: { 1: 'En horario laboral', 2: 'Por las tardes', 3: 'En horario flexible seg√∫n disponibilidad' },
    objetivo_epvsa: { 1: 'Incrementar los niveles de lactancia materna y el consumo de alimentos saludables', 2: 'Aumentar los niveles de actividad f√≠sica y disminuir los h√°bitos sedentarios', 3: 'Incrementar las horas y la calidad del sue√±o en la poblaci√≥n', 4: 'Incrementar la percepci√≥n de calidad de vida y de bienestar emocional', 5: 'Incrementar la percepci√≥n de satisfacci√≥n con las relaciones sexuales', 6: 'Disminuir el tiempo dedicado al uso de aparatos electr√≥nicos en detrimento del tiempo dedicado a familiares y amistades', 7: 'Incrementar las recomendaciones a la ciudadan√≠a sobre activos comunitarios que facilitan una vida saludable', 8: 'Incrementar el n√∫mero de empresas comprometidas con h√°bitos saludables y consumo sostenible', 9: 'Incrementar y favorecer la difusi√≥n de informaci√≥n sobre h√°bitos saludables', 10: 'Incrementar la formaci√≥n y la investigaci√≥n en promoci√≥n de h√°bitos saludables' },
    objetivo_epvsa_icon: { 1: 'ü§±', 2: 'üèÉ', 3: 'üò¥', 4: 'üòä', 5: '‚ù§Ô∏è', 6: 'üì±', 7: 'üèòÔ∏è', 8: 'üè¢', 9: 'üì¢', 10: 'üéì' },
    elementos: { 
        elem_cultura: 'Existe una cultura favorable a la promoci√≥n de la salud en Atenci√≥n Primaria', 
        elem_tiempo: 'Dispongo de tiempo suficiente en mi agenda para actividades de promoci√≥n de la salud', 
        elem_habilidades: 'Cuento con las habilidades y competencias necesarias para desarrollar actividades de promoci√≥n de la salud', 
        elem_espacios: 'Dispongo de espacios adecuados para realizar intervenciones de promoci√≥n de la salud', 
        elem_materiales: 'Dispongo de materiales y recursos suficientes para las intervenciones', 
        elem_acceso: 'Tengo acceso adecuado a la poblaci√≥n diana para las intervenciones', 
        elem_colaboracion: 'Existe buena colaboraci√≥n con otros profesionales para desarrollar actividades de promoci√≥n de la salud', 
        elem_recursos_ped: 'Cuento con recursos pedag√≥gicos y materiales did√°cticos adecuados', 
        elem_plan_formacion: 'El plan de formaci√≥n docente responde a mis necesidades en materia de promoci√≥n de la salud', 
        elem_tutor: 'Mi tutor/a facilita y apoya el desarrollo de actividades de promoci√≥n de la salud'
    },
    elementos_corto: { elem_cultura: 'Cultura Promoci√≥n', elem_tiempo: 'Tiempo agenda', elem_habilidades: 'Habilidades', elem_espacios: 'Espacios', elem_materiales: 'Materiales', elem_acceso: 'Acceso poblaci√≥n', elem_colaboracion: 'Colaboraci√≥n', elem_recursos_ped: 'Recursos pedag√≥gicos', elem_plan_formacion: 'Plan formaci√≥n', elem_tutor: 'Apoyo tutor' },
    diagnostico: {
        diag_caract_poblacion: 'Conozco las caracter√≠sticas sociodemogr√°ficas de la poblaci√≥n de referencia de mi UGC',
        diag_morbimortalidad: 'Conozco la situaci√≥n de salud (morbimortalidad) de la poblaci√≥n de referencia de mi UGC',
        diag_objetivos: 'Conozco los objetivos de promoci√≥n de la salud incluidos en los acuerdos de gesti√≥n de mi UGC'
    },
    diagnostico_corto: { diag_caract_poblacion: 'Caracter√≠sticas poblaci√≥n', diag_morbimortalidad: 'Morbimortalidad', diag_objetivos: 'Objetivos UGC' },
    colaboracion_externa: { 1: 'Administraci√≥n auton√≥mica presente en el territorio', 2: 'Administraci√≥n local (Ayuntamiento, Mancomunidad, Diputaci√≥n)', 3: 'Tejido social (Asociaciones de familiares, de pacientes, ONGs...)', 4: 'Centros de Participaci√≥n Activa (auton√≥micos y municipales)', 5: 'Centros de Educaci√≥n de Adultos', 6: 'Puntos Vuela', 7: 'Centros educativos' },
    colaboracion_externa_icon: { 1: 'üèõÔ∏è', 2: 'üè¢', 3: 'ü§≤', 4: 'üë¥', 5: 'üìñ', 6: '‚úàÔ∏è', 7: 'üè´' },
    colaboracion_profesionales: { 1: 'Director/a de la UGC', 2: 'Coordinador/a de Cuidados de Enfermer√≠a', 3: 'Profesionales de Medicina Familiar y Comunitaria (MFYC)', 4: 'Profesionales de Enfermer√≠a Familiar y Comunitaria (EFYC)', 5: 'Profesionales de Enfermer√≠a Referente de Centro Educativo (ERCE)', 6: 'Profesionales de Trabajo Social (TS)', 7: 'Profesionales de Fisioterapia', 8: 'Profesionales de Terapia Ocupacional (TO)', 9: 'Profesionales de la Enfermer√≠a Gestora de Casos', 10: 'Profesionales del Dispositivo de Cuidados Cr√≠ticos y Urgencias (DDCCUU)', 11: 'Profesionales de Pediatr√≠a' },
    colaboracion_profesionales_icon: { 1: 'üëî', 2: 'üë©‚Äç‚öïÔ∏è', 3: '‚öïÔ∏è', 4: 'üíâ', 5: 'üè´', 6: 'ü§ù', 7: 'ü¶ø', 8: 'üß©', 9: 'üìã', 10: 'üöë', 11: 'üë∂' },
    ugc_granada: { 1: 'Albayz√≠n', 2: 'Almanj√°yar', 3: 'Bola de Oro', 4: 'Caleta', 5: 'Cartuja', 6: 'Caser√≠a de Montijo', 7: 'Chana', 8: 'Doctores', 9: 'Flores-F√≠gares', 10: 'Fortuny/Velluti', 11: 'G√≥ngora', 12: 'Gran Capit√°n', 13: 'Realejo', 14: 'Zaid√≠n Centro-Este', 15: 'Zaid√≠n Sur' },
    ugc_metropolitano: { 1: 'Albolote', 2: 'Alfacar', 3: 'Alhama de Granada', 4: 'Armilla', 5: 'Atarfe', 6: 'Cenes de la Vega', 7: 'Churriana de la Vega', 8: 'Hu√©tor-T√°jar', 9: 'Hu√©tor-Vega', 10: '√çllora', 11: 'Iznalloz', 12: 'La Zubia', 13: 'Las Gabias', 14: 'Loja', 15: 'Maracena', 16: 'Montefr√≠o', 17: 'Og√≠jares', 18: 'Peligros', 19: 'Pinos Puente', 20: 'Santa Fe', 21: 'Valle de Lecr√≠n' },
    likert_acuerdo: ['Muy en desacuerdo', 'En desacuerdo', 'Ni de acuerdo ni en desacuerdo', 'De acuerdo', 'Muy de acuerdo'],
    escala_aspectos: ['Muy deficiente', '', '', '', '', '', '', '', '', 'Excelente'],
    likert_frecuencia: ['Nunca', 'Casi nunca', 'A veces', 'A menudo', 'Siempre'],
    likert_calidad: ['Muy deficiente', 'Deficiente', 'Aceptable', 'Buena', 'Excelente'],
    likert_aplicabilidad: ['Totalmente insuficiente', 'Insuficiente', 'Adecuada', 'Suficiente', 'Totalmente suficiente']
};

// ==================== INIT ====================
document.addEventListener('DOMContentLoaded', function() {
    firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    
    // Verificar conexi√≥n a Firebase
    const connectedRef = db.ref('.info/connected');
    connectedRef.on('value', (snap) => {
        const fbStatus = document.getElementById('firebaseStatus');
        const fbText = document.getElementById('firebaseStatusText');
        if (fbStatus && fbText) {
            if (snap.val() === true) {
                fbStatus.style.background = '#c6f6d5';
                fbStatus.style.color = '#276749';
                fbStatus.querySelector('.status-dot').style.background = '#38a169';
                fbText.textContent = 'üî• Firebase conectado ¬∑ Los datos se guardar√°n correctamente';
            } else {
                fbStatus.style.background = '#fed7d7';
                fbStatus.style.color = '#c53030';
                fbStatus.querySelector('.status-dot').style.background = '#e53e3e';
                fbText.textContent = '‚ö†Ô∏è Sin conexi√≥n a Firebase ¬∑ Los datos NO se guardar√°n';
            }
        }
    });
    
    const params = new URLSearchParams(window.location.search);
    if (params.get('s')) {
        sessionId = params.get('s');
        document.getElementById('panelMode').classList.add('hidden');
        document.getElementById('surveyMode').classList.remove('hidden');
        renderSurvey();
    } else {
        // Restaurar sesi√≥n guardada si existe
        const savedSession = localStorage.getItem('mireir_sessionId');
        if (savedSession) {
            restoreSession(savedSession);
        }
        updateAllStats();
    }
});

// ==================== NAVEGACI√ìN ====================
function showView(view) {
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.getElementById('view' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
    document.getElementById('btn' + view.charAt(0).toUpperCase() + view.slice(1)).classList.add('active');
    if (view === 'resultados') renderAllResults();
}

function showResultsTab(tab) {
    document.querySelectorAll('.results-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.results-content').forEach(c => c.classList.remove('active'));
    event.target.classList.add('active');
    document.getElementById('results' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
}

// ==================== SESI√ìN ====================
function startSession() {
    sessionActive = true;
    sessionId = Date.now().toString(36);
    localStorage.setItem('mireir_sessionId', sessionId);
    
    document.getElementById('btnStartSession').disabled = true;
    document.getElementById('btnStopSession').disabled = false;
    
    const status = document.getElementById('sessionStatus');
    status.className = 'session-status active';
    document.getElementById('sessionStatusText').textContent = 'Sesi√≥n activa ¬∑ ' + sessionId;
    
    const surveyUrl = window.location.origin + window.location.pathname + '?s=' + sessionId;
    document.getElementById('surveyUrl').textContent = surveyUrl;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: surveyUrl, width: 200, height: 200, colorDark: '#1a365d', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
    
    setupFirebaseListener();
}

function restoreSession(sid) {
    sessionActive = true;
    sessionId = sid;
    
    document.getElementById('btnStartSession').disabled = true;
    document.getElementById('btnStopSession').disabled = false;
    
    const status = document.getElementById('sessionStatus');
    status.className = 'session-status active';
    document.getElementById('sessionStatusText').textContent = 'Reconectando ¬∑ ' + sessionId;
    
    const surveyUrl = window.location.origin + window.location.pathname + '?s=' + sessionId;
    document.getElementById('surveyUrl').textContent = surveyUrl;
    document.getElementById('qrcode').innerHTML = '';
    new QRCode(document.getElementById('qrcode'), { text: surveyUrl, width: 200, height: 200, colorDark: '#1a365d', colorLight: '#ffffff', correctLevel: QRCode.CorrectLevel.H });
    
    // Cargar TODAS las respuestas existentes primero
    db.ref('encuestas_mireir/' + sessionId + '/responses').once('value', snapshot => {
        responses = [];
        if (snapshot.exists()) {
            snapshot.forEach(child => {
                responses.push(child.val());
            });
        }
        updateAllStats();
        document.getElementById('sessionStatusText').textContent = 'Sesi√≥n activa ¬∑ ' + sessionId + ' ¬∑ ' + responses.length + ' respuestas';
        
        // Luego configurar listener para nuevas respuestas
        setupFirebaseListener();
    });
}

function setupFirebaseListener() {
    db.ref('encuestas_mireir/' + sessionId + '/responses').on('child_added', snapshot => {
        const r = snapshot.val();
        if (!responses.find(x => x.id === r.id)) {
            responses.push(r);
            addLiveFeedItem(r);
            updateAllStats();
        }
    });
}

function stopSession() {
    sessionActive = false;
    document.getElementById('btnStartSession').disabled = false;
    document.getElementById('btnStopSession').disabled = true;
    const status = document.getElementById('sessionStatus');
    status.className = 'session-status inactive';
    document.getElementById('sessionStatusText').textContent = 'Sesi√≥n cerrada ¬∑ ' + responses.length + ' respuestas';
}

function resetSession() {
    if (!confirm('¬øBorrar todos los datos?')) return;
    if (sessionId) {
        db.ref('encuestas_mireir/' + sessionId + '/responses').off();
        db.ref('encuestas_mireir/' + sessionId).remove();
    }
    localStorage.removeItem('mireir_sessionId');
    responses = [];
    sessionActive = false;
    sessionId = null;
    document.getElementById('btnStartSession').disabled = false;
    document.getElementById('btnStopSession').disabled = true;
    document.getElementById('sessionStatus').className = 'session-status waiting';
    document.getElementById('sessionStatusText').textContent = 'Pulsa "Iniciar Sesi√≥n" para comenzar';
    document.getElementById('qrcode').innerHTML = '<div style="width:200px;height:200px;background:#f0f4f8;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#718096;font-size:3em">üì±</div>';
    document.getElementById('surveyUrl').textContent = 'El enlace aparecer√° aqu√≠';
    document.getElementById('liveFeed').innerHTML = '<div style="text-align:center;color:var(--text-light);padding:40px">Esperando respuestas...</div>';
    updateAllStats();
}

// ==================== LIVE FEED ====================
function addLiveFeedItem(r) {
    const feed = document.getElementById('liveFeed');
    if (feed.querySelector('div[style*="text-align:center"]')) feed.innerHTML = '';
    const tipo = r.tipo_residente == 1 ? 'mir' : 'eir';
    const tipoLabel = r.tipo_residente == 1 ? 'MIR' : 'EIR';
    const anio = r.tipo_residente == 1 ? r.anio_residencia_mir : r.anio_residencia_eir;
    const distrito = LABELS.distrito[r.distrito] || '';
    const time = new Date(r.timestamp || Date.now()).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
    const item = document.createElement('div');
    item.className = 'live-item';
    item.innerHTML = `<div class="icon ${tipo}">${tipo === 'mir' ? 'ü©∫' : 'üíâ'}</div><div class="info"><div class="name">${tipoLabel} R${anio || '?'}</div><div class="meta">${distrito}</div></div><div class="time">${time}</div>`;
    feed.insertBefore(item, feed.firstChild);
    while (feed.children.length > 20) feed.removeChild(feed.lastChild);
}

// ==================== STATS ====================
function updateAllStats() {
    const n = responses.length;
    const mir = responses.filter(r => r.tipo_residente == 1);
    const eir = responses.filter(r => r.tipo_residente == 2);
    const granada = responses.filter(r => r.distrito == 0).length;
    const metro = responses.filter(r => r.distrito == 1).length;
    
    document.getElementById('headerTotal').textContent = n;
    document.getElementById('headerMir').textContent = mir.length;
    document.getElementById('headerEir').textContent = eir.length;
    
    const pct = Math.min(100, (n / TARGET) * 100);
    document.getElementById('progressCircle').style.strokeDashoffset = 264 - (264 * pct / 100);
    document.getElementById('progressPercent').textContent = Math.round(pct) + '%';
    document.getElementById('progressCount').textContent = n + ' / ' + TARGET;
    
    document.getElementById('statMir').textContent = mir.length;
    document.getElementById('statEir').textContent = eir.length;
    document.getElementById('statGranada').textContent = granada;
    document.getElementById('statMetro').textContent = metro;
    
    const mT = mir.length || 1, eT = eir.length || 1;
    for (let i = 1; i <= 4; i++) { const c = mir.filter(r => r.anio_residencia_mir == i).length; document.getElementById('mirR' + i).textContent = c; document.getElementById('mirR' + i + 'Bar').style.width = (c / mT * 100) + '%'; }
    for (let i = 1; i <= 2; i++) { const c = eir.filter(r => r.anio_residencia_eir == i).length; document.getElementById('eirR' + i).textContent = c; document.getElementById('eirR' + i + 'Bar').style.width = (c / eT * 100) + '%'; }
}

// ==================== ENCUESTA ====================
let currentSection = 0;
let surveyData = {};

const SURVEY_SECTIONS = [
    { title: 'Datos sociodemogr√°ficos', questions: [
        { id: 'sexo', label: 'Sexo', type: 'radio', options: LABELS.sexo },
        { id: 'edad', label: 'Edad (a√±os)', type: 'number', min: 20, max: 70, note: 'Indica tu edad en a√±os' },
        { id: 'tipo_residente', label: 'Tipo de residente', type: 'radio', options: LABELS.tipo_residente },
        { id: 'anio_residencia', label: 'A√±o de residencia', type: 'dynamic' },
        { id: 'distrito', label: 'Distrito', type: 'radio', options: LABELS.distrito },
        { id: 'ugc', label: 'Unidad de Gesti√≥n Cl√≠nica', type: 'dynamic' }
    ]},
    { title: 'Formaci√≥n en Promoci√≥n de la Salud', questions: [
        { id: 'participacion_promocion', label: 'Indica con qu√© frecuencia participas en actividades de promoci√≥n de la salud en tu Unidad de Gesti√≥n Cl√≠nica', type: 'likert', scale: LABELS.likert_frecuencia },
        { id: 'valoracion_formacion', label: 'Valora la calidad de la formaci√≥n que recibiste durante el per√≠odo de formaci√≥n de Grado', type: 'likert', scale: LABELS.likert_calidad },
        { id: 'valoracion_formacion_2', label: 'Valora la calidad de la formaci√≥n que has recibido hasta el momento durante tu residencia', type: 'likert', scale: LABELS.likert_calidad },
        { id: 'aplicabilidad_formacion', label: 'Valora en qu√© medida la formaci√≥n recibida hasta el momento en promoci√≥n de la salud es aplicable a tu pr√°ctica profesional', type: 'likert', scale: LABELS.likert_aplicabilidad },
        { id: 'tematicas_formacion', label: 'Selecciona todas aquellas tem√°ticas sobre las cuales te gustar√≠a recibir formaci√≥n', type: 'checkbox', options: LABELS.tematicas_formacion },
        { id: 'tematicas_otras', label: 'Especifica otras tem√°ticas de inter√©s', type: 'text', note: 'Indica otras tem√°ticas formativas que sean de tu inter√©s', conditional: 'tematicas_formacion___5' },
        { id: 'disponibilidad_horaria', label: 'Selecciona tu disponibilidad horaria para recibir formaci√≥n', type: 'checkbox', options: LABELS.disponibilidad_horaria },
        { id: 'modalidad_formacion', label: 'Indica qu√© modalidad de formaci√≥n prefieres', type: 'radio', options: LABELS.modalidad }
    ]},
    { title: 'Objetivos estrat√©gicos de la Estrategia de Promoci√≥n de una Vida Saludable en Andaluc√≠a (EPVSA)', questions: [
        { id: 'objetivo_epvsa', label: 'Selecciona de entre los siguientes el objetivo que sea de mayor inter√©s para ti', type: 'radio', options: LABELS.objetivo_epvsa }
    ]},
    { title: 'Condiciones para tu intervenci√≥n en promoci√≥n de la salud', questions: [
        { id: 'elementos', label: 'Valora las distintas condiciones relacionadas con la promoci√≥n de la salud durante tu tiempo de residencia en un centro de Atenci√≥n Primaria (1 = Muy deficiente, 10 = Excelente):', type: 'matrix', items: LABELS.elementos, scale: LABELS.escala_aspectos }
    ]},
    { title: 'Diagn√≥stico comunitario', questions: [
        { id: 'diagnostico', label: 'Indica tu grado de acuerdo con las siguientes afirmaciones:', type: 'matrix', items: LABELS.diagnostico, scale: LABELS.likert_acuerdo },
        { id: 'colaboracion_externa', label: 'Indica con cu√°l o cu√°les de las siguientes organizaciones has colaborado en promoci√≥n de la salud', type: 'checkbox', options: LABELS.colaboracion_externa },
        { id: 'colaboracion_profesionales', label: 'En el caso de haberlo hecho, ¬øcon qu√© profesionales has colaborado en promoci√≥n de la salud?', type: 'checkbox', options: LABELS.colaboracion_profesionales },
        { id: 'comentarios_adicionales', label: '¬øHay alguna otra cosa sobre la cual no te hayamos preguntado y sobre la cual te gustar√≠a comentar algo?', type: 'textarea' }
    ]}
];

function renderSurvey() { renderSurveySection(); }

function renderSurveySection() {
    const section = SURVEY_SECTIONS[currentSection];
    const progress = ((currentSection + 1) / SURVEY_SECTIONS.length) * 100;
    document.getElementById('surveyProgressBar').style.width = progress + '%';
    
    let html = `<div class="survey-section"><h3>${currentSection + 1}/${SURVEY_SECTIONS.length}. ${section.title}</h3>`;
    section.questions.forEach(q => html += renderQuestion(q));
    html += '</div>';
    html += `<div class="survey-nav">
        <button class="survey-btn prev" onclick="prevSection()" ${currentSection === 0 ? 'disabled' : ''}>‚Üê Anterior</button>
        ${currentSection === SURVEY_SECTIONS.length - 1 ? '<button class="survey-btn submit" onclick="submitSurvey()">Enviar ‚úì</button>' : '<button class="survey-btn next" onclick="nextSection()">Siguiente ‚Üí</button>'}
    </div>`;
    document.getElementById('surveyContent').innerHTML = html;
}

function renderQuestion(q) {
    // Verificar condicional
    if (q.conditional && surveyData[q.conditional] != 1) {
        return '';
    }
    
    let html = `<div class="survey-question">`;
    if (q.type === 'radio') {
        html += `<label>${q.label}</label><div class="radio-group">`;
        Object.entries(q.options).forEach(([val, text]) => {
            html += `<div class="radio-option ${surveyData[q.id] == val ? 'selected' : ''}" onclick="selectRadio('${q.id}', ${val}, this)"><input type="radio" name="${q.id}" value="${val}"><span>${text}</span></div>`;
        });
        html += '</div>';
    } else if (q.type === 'number') {
        html += `<label>${q.label}</label>`;
        if (q.note) html += `<div style="font-size:0.85em;color:var(--text-light);margin-bottom:8px">${q.note}</div>`;
        html += `<input type="number" class="survey-select" min="${q.min || ''}" max="${q.max || ''}" value="${surveyData[q.id] || ''}" onchange="surveyData['${q.id}']=this.value" style="max-width:150px">`;
    } else if (q.type === 'text') {
        html += `<label>${q.label}</label>`;
        if (q.note) html += `<div style="font-size:0.85em;color:var(--text-light);margin-bottom:8px">${q.note}</div>`;
        html += `<input type="text" class="survey-select" value="${surveyData[q.id] || ''}" onchange="surveyData['${q.id}']=this.value">`;
    } else if (q.type === 'textarea') {
        html += `<label>${q.label}</label>`;
        html += `<textarea class="survey-select" rows="4" style="resize:vertical" onchange="surveyData['${q.id}']=this.value">${surveyData[q.id] || ''}</textarea>`;
    } else if (q.type === 'likert') {
        html += `<label>${q.label}</label><div class="likert-scale">`;
        q.scale.forEach((text, i) => {
            const val = i + 1;
            html += `<div class="likert-option ${surveyData[q.id] == val ? 'selected' : ''}" onclick="selectLikert('${q.id}', ${val}, this)"><div class="number">${val}</div><div class="text">${text}</div></div>`;
        });
        html += '</div>';
    } else if (q.type === 'checkbox') {
        html += `<label>${q.label}</label><div class="checkbox-group">`;
        Object.entries(q.options).forEach(([val, text]) => {
            html += `<div class="checkbox-option ${surveyData[`${q.id}___${val}`] == 1 ? 'selected' : ''}" onclick="toggleCheckbox('${q.id}', ${val}, this)"><span>${val}. ${text}</span></div>`;
        });
        html += '</div>';
    } else if (q.type === 'matrix') {
        html += `<label>${q.label}</label><div class="matrix-container"><table class="matrix-table"><tr><th></th>${q.scale.map((s, i) => `<th>${i + 1}${s ? '<br><small>' + s + '</small>' : ''}</th>`).join('')}</tr>`;
        Object.entries(q.items).forEach(([key, text]) => {
            html += `<tr><td>${text}</td>`;
            for (let i = 1; i <= q.scale.length; i++) html += `<td><input type="radio" class="matrix-radio" name="${key}" value="${i}" ${surveyData[key] == i ? 'checked' : ''} onchange="surveyData['${key}']=${i}"></td>`;
            html += '</tr>';
        });
        html += '</table></div>';
        html += '</table></div>';
    } else if (q.type === 'dynamic' && q.id === 'anio_residencia') {
        const tipo = surveyData.tipo_residente;
        if (tipo == 1) {
            html += `<label>A√±o de residencia MIR</label><div class="radio-group">`;
            Object.entries(LABELS.anio_mir).forEach(([v, t]) => { html += `<div class="radio-option ${surveyData.anio_residencia_mir == v ? 'selected' : ''}" onclick="selectRadio('anio_residencia_mir', ${v}, this)"><input type="radio"><span>${t}</span></div>`; });
            html += '</div>';
        } else if (tipo == 2) {
            html += `<label>A√±o de residencia EIR</label><div class="radio-group">`;
            Object.entries(LABELS.anio_eir).forEach(([v, t]) => { html += `<div class="radio-option ${surveyData.anio_residencia_eir == v ? 'selected' : ''}" onclick="selectRadio('anio_residencia_eir', ${v}, this)"><input type="radio"><span>${t}</span></div>`; });
            html += '</div>';
        } else html += '<p style="color:var(--text-light);font-style:italic">Selecciona primero el tipo de residente</p>';
    } else if (q.type === 'dynamic' && q.id === 'ugc') {
        const d = surveyData.distrito;
        const list = d == 0 ? LABELS.ugc_granada : d == 1 ? LABELS.ugc_metropolitano : null;
        if (list) {
            const f = d == 0 ? 'ugc_granada' : 'ugc_metropolitano';
            html += `<label>Unidad de Gesti√≥n Cl√≠nica</label><div style="font-size:0.85em;color:var(--text-light);margin-bottom:8px">Selecciona la UGC donde realizas tu residencia</div><select class="survey-select" onchange="surveyData['${f}']=this.value"><option value="">Selecciona tu UGC...</option>${Object.entries(list).map(([v, t]) => `<option value="${v}" ${surveyData[f] == v ? 'selected' : ''}>${t}</option>`).join('')}</select>`;
        } else html += '<p style="color:var(--text-light);font-style:italic">Selecciona primero el distrito</p>';
    }
    html += '</div>';
    return html;
}

function selectRadio(f, v, el) { surveyData[f] = v; el.parentElement.querySelectorAll('.radio-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); if (f === 'tipo_residente' || f === 'distrito' || f.startsWith('tematicas')) setTimeout(renderSurveySection, 50); }
function selectLikert(f, v, el) { surveyData[f] = v; el.parentElement.querySelectorAll('.likert-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); }
function toggleCheckbox(f, v, el) { const k = `${f}___${v}`; surveyData[k] = surveyData[k] == 1 ? 0 : 1; el.classList.toggle('selected'); if (f === 'tematicas_formacion') setTimeout(renderSurveySection, 50); }
function nextSection() { if (currentSection < SURVEY_SECTIONS.length - 1) { currentSection++; renderSurveySection(); window.scrollTo(0, 0); } }
function prevSection() { if (currentSection > 0) { currentSection--; renderSurveySection(); window.scrollTo(0, 0); } }

function submitSurvey() {
    surveyData.id = Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
    surveyData.timestamp = Date.now();
    const params = new URLSearchParams(window.location.search);
    const sid = params.get('s') || 'default';
    db.ref('encuestas_mireir/' + sid + '/responses').push(surveyData);
    document.getElementById('surveyContent').innerHTML = `<div class="survey-complete"><div class="icon">‚úÖ</div><h2>¬°Gracias por participar!</h2><p>Tu respuesta ha sido registrada correctamente.</p></div>`;
}

// ==================== RESULTADOS ====================
function renderAllResults() {
    if (responses.length === 0) {
        ['Resumen', 'Perfil', 'Comparativa', 'Sexo', 'Promotor', 'Formacion', 'Elementos', 'Diagnostico', 'Colaboracion', 'Epvsa'].forEach(t => {
            document.getElementById('results' + t).innerHTML = '<div class="card"><p style="text-align:center;color:var(--text-light);padding:40px">No hay respuestas todav√≠a</p></div>';
        });
        return;
    }
    renderResultsResumen();
    renderResultsPerfil();
    renderResultsComparativa();
    renderResultsSexo();
    renderResultsPromotor();
    renderResultsFormacion();
    renderResultsElementos();
    renderResultsDiagnostico();
    renderResultsColaboracion();
    renderResultsEpvsa();
}

function calcMedia(f) { const v = responses.map(r => parseFloat(r[f])).filter(x => x && !isNaN(x)); return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0; }
function getColor(v) { return v >= 3.5 ? '#38a169' : v >= 2.5 ? '#d69e2e' : '#e53e3e'; }
function getColor10(v) { return v >= 7 ? '#38a169' : v >= 5 ? '#d69e2e' : '#e53e3e'; }
function gaugeSVG(v) { const p = (v / 5) * 100; return `<svg class="gauge-svg" viewBox="0 0 100 60"><path d="M10 55 A40 40 0 0 1 90 55" fill="none" stroke="#e2e8f0" stroke-width="8" stroke-linecap="round"/><path d="M10 55 A40 40 0 0 1 90 55" fill="none" stroke="url(#gg)" stroke-width="8" stroke-linecap="round" stroke-dasharray="${p * 1.26} 126"/><defs><linearGradient id="gg"><stop offset="0%" stop-color="#e53e3e"/><stop offset="50%" stop-color="#d69e2e"/><stop offset="100%" stop-color="#38a169"/></linearGradient></defs></svg>`; }

function renderResultsResumen() {
    const mP = calcMedia('participacion_promocion'), mG = calcMedia('valoracion_formacion'), mR = calcMedia('valoracion_formacion_2'), mA = calcMedia('aplicabilidad_formacion');
    const elemItems = Object.entries(LABELS.elementos_corto).map(([k, v]) => ({ label: v, value: calcMedia(k) })).sort((a, b) => a.value - b.value);
    
    // Generar an√°lisis descriptivo
    const nivelParticipacion = mP >= 4 ? 'alta' : mP >= 3 ? 'moderada' : mP >= 2 ? 'baja' : 'muy baja';
    const diffFormacion = mR - mG;
    const aspectosBajos = elemItems.filter(i => i.value < 5);
    
    let analisis = `<div style="background:#f0f4f8;border-radius:10px;padding:15px;margin-top:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> La participaci√≥n en promoci√≥n de la salud se sit√∫a en ${mP.toFixed(1)}/5 (<strong>${nivelParticipacion}</strong>). `;
    
    // Solo comentar diferencia si es apreciable (>0.3 puntos)
    if (Math.abs(diffFormacion) >= 0.3) {
        if (diffFormacion > 0) {
            analisis += `La formaci√≥n en Residencia (${mR.toFixed(1)}) se valora ${diffFormacion.toFixed(1)} puntos por encima de la del Grado (${mG.toFixed(1)}). `;
        } else {
            analisis += `La formaci√≥n en Residencia (${mR.toFixed(1)}) se valora ${Math.abs(diffFormacion).toFixed(1)} puntos por debajo de la del Grado (${mG.toFixed(1)}). `;
        }
    } else {
        analisis += `La valoraci√≥n de la formaci√≥n en Grado (${mG.toFixed(1)}) y Residencia (${mR.toFixed(1)}) es similar. `;
    }
    
    analisis += `La aplicabilidad de la formaci√≥n recibida obtiene un ${mA.toFixed(1)}/5. `;
    
    if (aspectosBajos.length > 0) {
        analisis += `<br><br><strong>${aspectosBajos.length} condici√≥n(es)</strong> obtienen puntuaci√≥n inferior a 5/10: ${aspectosBajos.slice(0, 3).map(i => i.label.toLowerCase()).join(', ')}${aspectosBajos.length > 3 ? '...' : ''}.`;
    } else {
        analisis += `Todas las condiciones superan la puntuaci√≥n de 5/10.`;
    }
    analisis += '</div>';
    
    document.getElementById('resultsResumen').innerHTML = `
        <div class="card"><h2>üìä Indicadores principales</h2>
            <div class="gauge-row">
                <div class="gauge-item">${gaugeSVG(mP)}<div class="gauge-value">${mP.toFixed(1)}</div><div class="gauge-label">Participaci√≥n</div><div style="font-size:0.65em;color:#718096">(1-5)</div></div>
                <div class="gauge-item">${gaugeSVG(mG)}<div class="gauge-value">${mG.toFixed(1)}</div><div class="gauge-label">Form. Grado</div><div style="font-size:0.65em;color:#718096">(1-5)</div></div>
                <div class="gauge-item">${gaugeSVG(mR)}<div class="gauge-value">${mR.toFixed(1)}</div><div class="gauge-label">Form. Residencia</div><div style="font-size:0.65em;color:#718096">(1-5)</div></div>
                <div class="gauge-item">${gaugeSVG(mA)}<div class="gauge-value">${mA.toFixed(1)}</div><div class="gauge-label">Aplicabilidad</div><div style="font-size:0.65em;color:#718096">(1-5)</div></div>
            </div>
            ${analisis}
        </div>
        <div class="card"><h2>‚ö†Ô∏è Condiciones con menor puntuaci√≥n</h2>
            <p style="color:var(--text-light);margin-bottom:10px;font-size:0.85em">Escala 1-10 (1 = Muy deficiente, 10 = Excelente)</p>
            ${elemItems.slice(0, 5).map(i => { const p = (i.value / 10) * 100, c = getColor10(i.value); return `<div class="lollipop-item"><div class="lollipop-label">${i.label}</div><div class="lollipop-track"><div class="lollipop-line" style="width:${p}%;background:${c}"></div><div class="lollipop-dot" style="left:calc(${p}% - 12px);background:${c}">${i.value.toFixed(1)}</div></div></div>`; }).join('')}
        </div>`;
}

function renderResultsPerfil() {
    const n = responses.length;
    const sexoCounts = {}, tipoCounts = {}, distritoCounts = {};
    responses.forEach(r => {
        sexoCounts[r.sexo] = (sexoCounts[r.sexo] || 0) + 1;
        tipoCounts[r.tipo_residente] = (tipoCounts[r.tipo_residente] || 0) + 1;
        distritoCounts[r.distrito] = (distritoCounts[r.distrito] || 0) + 1;
    });
    
    // Pictogram
    let pictoHtml = '<div class="pictogram">';
    Object.entries(sexoCounts).forEach(([k, v]) => { for (let i = 0; i < v; i++) pictoHtml += `<span class="pictogram-icon" style="color:${LABELS.sexo_color[k]}">${LABELS.sexo_icon[k]}</span>`; });
    pictoHtml += '</div><div class="pictogram-legend">';
    Object.entries(sexoCounts).forEach(([k, v]) => { pictoHtml += `<div class="pictogram-legend-item"><span style="color:${LABELS.sexo_color[k]}">${LABELS.sexo_icon[k]}</span> ${LABELS.sexo[k]}: ${v} (${(v/n*100).toFixed(0)}%)</div>`; });
    pictoHtml += '</div>';
    
    // Waffle tipo
    let waffleTipo = '<div class="waffle">';
    const mirPct = Math.round(((tipoCounts[1] || 0) / n) * 100);
    for (let i = 0; i < 100; i++) waffleTipo += `<div class="waffle-cell" style="background:${i < mirPct ? '#2c5282' : '#ed8936'}"></div>`;
    waffleTipo += `</div><div class="waffle-legend"><div class="waffle-legend-item"><div class="waffle-legend-color" style="background:#2c5282"></div>MIR ${mirPct}%</div><div class="waffle-legend-item"><div class="waffle-legend-color" style="background:#ed8936"></div>EIR ${100 - mirPct}%</div></div>`;
    
    // Waffle distrito
    let waffleDist = '<div class="waffle">';
    const grPct = Math.round(((distritoCounts[0] || 0) / n) * 100);
    for (let i = 0; i < 100; i++) waffleDist += `<div class="waffle-cell" style="background:${i < grPct ? '#38a169' : '#d69e2e'}"></div>`;
    waffleDist += `</div><div class="waffle-legend"><div class="waffle-legend-item"><div class="waffle-legend-color" style="background:#38a169"></div>Granada ${grPct}%</div><div class="waffle-legend-item"><div class="waffle-legend-color" style="background:#d69e2e"></div>Metropolitano ${100 - grPct}%</div></div>`;
    
    // An√°lisis descriptivo
    const nMujeres = sexoCounts[2] || 0;
    const nHombres = sexoCounts[1] || 0;
    const pctMujeres = (nMujeres / n * 100).toFixed(0);
    const nMir = tipoCounts[1] || 0;
    const nEir = tipoCounts[2] || 0;
    
    let analisisPerfil = `<div class="card"><div style="background:#f0f4f8;border-radius:10px;padding:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> Muestra de <strong>${n} residentes</strong>: ${nMujeres} mujeres (${pctMujeres}%) y ${nHombres} hombres (${(100-pctMujeres)}%). `;
    analisisPerfil += `Por tipo: ${nMir} MIR (${mirPct}%) y ${nEir} EIR (${100-mirPct}%). `;
    analisisPerfil += `Por distrito: Granada ${grPct}% y Metropolitano ${100-grPct}%.`;
    analisisPerfil += '</div></div>';
    
    document.getElementById('resultsPerfil').innerHTML = `
        <div class="card"><h2>üë• Distribuci√≥n por sexo</h2>${pictoHtml}</div>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:18px">
            <div class="card"><h2>üéì Tipo de residente</h2>${waffleTipo}</div>
            <div class="card"><h2>üìç Distrito</h2>${waffleDist}</div>
        </div>
        ${analisisPerfil}`;
}

function renderResultsFormacion() {
    const modCounts = {};
    responses.forEach(r => { if (r.modalidad_formacion) modCounts[r.modalidad_formacion] = (modCounts[r.modalidad_formacion] || 0) + 1; });
    const n = responses.length || 1;
    
    // Ordenar por porcentaje descendente
    const modSorted = Object.entries(LABELS.modalidad).map(([k, v]) => ({ k, v, p: ((modCounts[k] || 0) / n * 100) })).sort((a, b) => b.p - a.p);
    
    // An√°lisis descriptivo
    let analisisFormacion = `<div style="background:#f0f4f8;border-radius:10px;padding:15px;margin-top:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> Preferencias de modalidad formativa: `;
    analisisFormacion += modSorted.map(m => `<strong>${m.v}</strong> ${m.p.toFixed(0)}%`).join(', ') + '.';
    analisisFormacion += '</div>';
    
    document.getElementById('resultsFormacion').innerHTML = `
        <div class="card"><h2>üéì Modalidad preferida</h2>
            <div style="display:flex;justify-content:space-around;margin:30px 0">
                ${modSorted.map(item => `<div style="text-align:center"><div style="font-size:3em">${LABELS.modalidad_icon[item.k]}</div><div style="font-size:2em;font-weight:700;color:var(--primary)">${item.p.toFixed(0)}%</div><div style="color:var(--text-light)">${item.v}</div></div>`).join('')}
            </div>
            ${analisisFormacion}
        </div>`;
}

function renderResultsElementos() {
    const items = Object.entries(LABELS.elementos_corto).map(([k, v]) => ({ label: v, value: calcMedia(k) })).sort((a, b) => b.value - a.value);
    
    // An√°lisis descriptivo
    const mejorAspecto = items[0];
    const peorAspecto = items[items.length - 1];
    const mediaGeneral = items.reduce((a, b) => a + b.value, 0) / items.length;
    const aspectosBajos = items.filter(i => i.value < 5);
    const aspectosAltos = items.filter(i => i.value >= 7);
    
    let analisisElementos = `<div style="background:#f0f4f8;border-radius:10px;padding:15px;margin-top:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> Media global: <strong>${mediaGeneral.toFixed(1)}/10</strong>. `;
    analisisElementos += `Puntuaci√≥n m√°s alta: "<strong>${mejorAspecto.label}</strong>" (${mejorAspecto.value.toFixed(1)}). `;
    analisisElementos += `Puntuaci√≥n m√°s baja: "<strong>${peorAspecto.label}</strong>" (${peorAspecto.value.toFixed(1)}). `;
    analisisElementos += `<br><br>${aspectosAltos.length} condici√≥n(es) ‚â•7 | ${aspectosBajos.length} condici√≥n(es) <5.`;
    analisisElementos += '</div>';
    
    document.getElementById('resultsElementos').innerHTML = `<div class="card"><h2>‚öôÔ∏è Condiciones para tu intervenci√≥n en promoci√≥n de la salud</h2>
        <p style="color:var(--text-light);margin-bottom:15px;font-size:0.9em">Valoraci√≥n media de cada condici√≥n (escala 1-10: 1 = Muy deficiente, 10 = Excelente)</p>
        ${items.map(i => { const p = (i.value / 10) * 100, c = getColor10(i.value); return `<div class="lollipop-item"><div class="lollipop-label">${i.label}</div><div class="lollipop-track"><div class="lollipop-line" style="width:${p}%;background:${c}"></div><div class="lollipop-dot" style="left:calc(${p}% - 12px);background:${c}">${i.value.toFixed(1)}</div></div></div>`; }).join('')}
        ${analisisElementos}
    </div>`;
}

function renderResultsDiagnostico() {
    // Usar etiquetas completas para que se entienda qu√© se pregunta
    const items = Object.entries(LABELS.diagnostico).map(([k, v]) => ({ key: k, label: v, value: calcMedia(k) })).sort((a, b) => b.value - a.value);
    
    // An√°lisis descriptivo
    const mediaGeneral = items.reduce((a, b) => a + b.value, 0) / items.length;
    const mejorItem = items[0];
    const peorItem = items[items.length - 1];
    
    let analisisDiag = `<div style="background:#f0f4f8;border-radius:10px;padding:15px;margin-top:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> Media global: <strong>${mediaGeneral.toFixed(1)}/5</strong>. `;
    analisisDiag += `Puntuaci√≥n m√°s alta: "${LABELS.diagnostico_corto[mejorItem.key]}" (${mejorItem.value.toFixed(1)}). `;
    analisisDiag += `Puntuaci√≥n m√°s baja: "${LABELS.diagnostico_corto[peorItem.key]}" (${peorItem.value.toFixed(1)}).`;
    analisisDiag += '</div>';
    
    document.getElementById('resultsDiagnostico').innerHTML = `<div class="card"><h2>üî¨ Diagn√≥stico comunitario</h2>
        <p style="color:var(--text-light);margin-bottom:8px;font-size:0.9em"><strong>Pregunta:</strong> "Indica tu grado de acuerdo con las siguientes afirmaciones"</p>
        <p style="color:var(--text-light);margin-bottom:15px;font-size:0.85em">Escala: 1 = Muy en desacuerdo ... 5 = Muy de acuerdo</p>
        ${items.map(i => { const p = (i.value / 5) * 100, c = getColor(i.value); return `<div class="lollipop-item"><div class="lollipop-label" style="font-size:0.85em">${i.label}</div><div class="lollipop-track"><div class="lollipop-line" style="width:${p}%;background:${c}"></div><div class="lollipop-dot" style="left:calc(${p}% - 12px);background:${c}">${i.value.toFixed(1)}</div></div></div>`; }).join('')}
        ${analisisDiag}
    </div>`;
}

function renderResultsColaboracion() {
    const n = responses.length || 1;
    const extC = {}, profC = {};
    for (let i = 1; i <= 7; i++) extC[i] = responses.filter(r => r[`colaboracion_externa___${i}`] == 1).length;
    for (let i = 1; i <= 11; i++) profC[i] = responses.filter(r => r[`colaboracion_profesionales___${i}`] == 1).length;
    
    // Ordenar por porcentaje descendente
    const extSorted = Object.entries(LABELS.colaboracion_externa).map(([k, v]) => ({ k, v, p: (extC[k] || 0) / n * 100 })).sort((a, b) => b.p - a.p);
    const profSorted = Object.entries(LABELS.colaboracion_profesionales).map(([k, v]) => ({ k, v, p: (profC[k] || 0) / n * 100 })).sort((a, b) => b.p - a.p);
    
    // An√°lisis descriptivo
    let analisisColab = `<div class="card"><div style="background:#f0f4f8;border-radius:10px;padding:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> `;
    
    if (extSorted[0] && extSorted[1]) {
        analisisColab += `<strong>Organizaciones externas</strong> con mayor colaboraci√≥n: ${extSorted[0].v} (${extSorted[0].p.toFixed(0)}%), ${extSorted[1].v} (${extSorted[1].p.toFixed(0)}%). `;
    }
    
    if (profSorted[0] && profSorted[1]) {
        analisisColab += `<br><br><strong>Profesionales UGC</strong> con mayor colaboraci√≥n: ${profSorted[0].v} (${profSorted[0].p.toFixed(0)}%), ${profSorted[1].v} (${profSorted[1].p.toFixed(0)}%).`;
    }
    analisisColab += '</div></div>';
    
    document.getElementById('resultsColaboracion').innerHTML = `
        <div class="card"><h2>üèõÔ∏è Organizaciones externas</h2><div class="collab-grid">${extSorted.map(item => `<div class="collab-item ${item.p > 50 ? 'high' : ''}"><div class="icon">${LABELS.colaboracion_externa_icon[item.k]}</div><div class="name">${item.v}</div><div class="pct">${item.p.toFixed(0)}%</div></div>`).join('')}</div></div>
        <div class="card"><h2>üë®‚Äç‚öïÔ∏è Profesionales UGC</h2><div class="collab-grid">${profSorted.map(item => `<div class="collab-item ${item.p > 50 ? 'high' : ''}"><div class="icon">${LABELS.colaboracion_profesionales_icon[item.k]}</div><div class="name">${item.v}</div><div class="pct">${item.p.toFixed(0)}%</div></div>`).join('')}</div></div>
        ${analisisColab}`;
}

function renderResultsEpvsa() {
    const counts = {};
    responses.forEach(r => { if (r.objetivo_epvsa) counts[r.objetivo_epvsa] = (counts[r.objetivo_epvsa] || 0) + 1; });
    const total = Object.values(counts).reduce((a, b) => a + b, 0) || 1;
    const sorted = Object.entries(counts).sort((a, b) => b[1] - a[1]);
    
    // An√°lisis descriptivo
    const top3 = sorted.slice(0, 3);
    
    let analisisEpvsa = `<div style="background:#f0f4f8;border-radius:10px;padding:15px;margin-top:15px;font-size:0.9em;line-height:1.6">
        <strong>üìù An√°lisis:</strong> Objetivos m√°s seleccionados: `;
    
    analisisEpvsa += top3.map((item, i) => {
        const label = LABELS.objetivo_epvsa[item[0]];
        const pct = (item[1]/total*100).toFixed(0);
        return `${i+1}¬∫ ${label ? label.split(' ').slice(0, 6).join(' ') + '...' : 'N/A'} (${pct}%)`;
    }).join(' | ');
    analisisEpvsa += '</div>';
    
    document.getElementById('resultsEpvsa').innerHTML = `<div class="card"><h2>üéØ Objetivos estrat√©gicos de la EPVSA</h2>
        <p style="color:var(--text-light);margin-bottom:15px;font-size:0.9em">Estrategia de Promoci√≥n de una Vida Saludable en Andaluc√≠a - Objetivo prioritario seleccionado por cada residente</p>
        ${sorted.map(([k, v], i) => `<div class="ranking-item"><div class="pos">${i + 1}</div><div class="icon">${LABELS.objetivo_epvsa_icon[k]}</div><div class="text">${LABELS.objetivo_epvsa[k]}</div><div class="value">${(v / total * 100).toFixed(0)}%</div></div>`).join('')}
        ${analisisEpvsa}
    </div>`;
}

// ==================== COMPARATIVA MIR vs EIR ====================
function renderResultsComparativa() {
    const mir = responses.filter(r => r.tipo_residente == 1);
    const eir = responses.filter(r => r.tipo_residente == 2);
    
    function calcMediaGrupo(arr, field) {
        const v = arr.map(r => parseFloat(r[field])).filter(x => x && !isNaN(x));
        return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
    }
    
    const indicadores = [
        { key: 'participacion_promocion', label: 'Participaci√≥n en promoci√≥n de la salud' },
        { key: 'valoracion_formacion', label: 'Valoraci√≥n formaci√≥n Grado' },
        { key: 'valoracion_formacion_2', label: 'Valoraci√≥n formaci√≥n Residencia' },
        { key: 'aplicabilidad_formacion', label: 'Aplicabilidad de la formaci√≥n' }
    ];
    
    let indicadoresHtml = indicadores.map(ind => {
        const mMir = calcMediaGrupo(mir, ind.key);
        const mEir = calcMediaGrupo(eir, ind.key);
        const diff = mMir - mEir;
        const diffIcon = Math.abs(diff) >= 0.5 ? (diff > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è') : '‚ûñ';
        const diffColor = Math.abs(diff) >= 0.5 ? (diff > 0 ? 'var(--success)' : 'var(--danger)') : 'var(--text-light)';
        return `<tr>
            <td style="text-align:left;padding:10px;font-size:0.9em">${ind.label}</td>
            <td style="text-align:center;padding:10px;font-weight:700;color:#2c5282">${mMir.toFixed(2)}</td>
            <td style="text-align:center;padding:10px;font-weight:700;color:#ed8936">${mEir.toFixed(2)}</td>
            <td style="text-align:center;padding:10px;color:${diffColor}">${diffIcon} ${diff >= 0 ? '+' : ''}${diff.toFixed(2)}</td>
        </tr>`;
    }).join('');
    
    const elemKeys = Object.keys(LABELS.elementos_corto);
    let elementosHtml = elemKeys.map(key => {
        const mMir = calcMediaGrupo(mir, key);
        const mEir = calcMediaGrupo(eir, key);
        const diff = mMir - mEir;
        const diffIcon = Math.abs(diff) >= 1.0 ? (diff > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è') : '‚ûñ';
        const diffColor = Math.abs(diff) >= 1.0 ? (diff > 0 ? 'var(--success)' : 'var(--danger)') : 'var(--text-light)';
        return `<tr>
            <td style="text-align:left;padding:8px;font-size:0.85em">${LABELS.elementos_corto[key]}</td>
            <td style="text-align:center;padding:8px;font-weight:600;color:#2c5282">${mMir.toFixed(2)}</td>
            <td style="text-align:center;padding:8px;font-weight:600;color:#ed8936">${mEir.toFixed(2)}</td>
            <td style="text-align:center;padding:8px;color:${diffColor}">${diffIcon}</td>
        </tr>`;
    }).join('');
    
    document.getElementById('resultsComparativa').innerHTML = `
        <div class="card">
            <h2>üìä Comparativa MIR vs EIR - Indicadores principales</h2>
            <p style="color:var(--text-light);margin-bottom:15px;font-size:0.9em">Diferencias ‚â• 0.5 puntos se resaltan con ‚¨ÜÔ∏è‚¨áÔ∏è</p>
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="background:var(--bg)">
                            <th style="text-align:left;padding:12px;font-weight:600">Indicador</th>
                            <th style="text-align:center;padding:12px;color:#2c5282;font-weight:600">ü©∫ MIR (n=${mir.length})</th>
                            <th style="text-align:center;padding:12px;color:#ed8936;font-weight:600">üíâ EIR (n=${eir.length})</th>
                            <th style="text-align:center;padding:12px;font-weight:600">Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>${indicadoresHtml}</tbody>
                </table>
            </div>
        </div>
        <div class="card">
            <h2>üìã Condiciones para la intervenci√≥n en promoci√≥n de la salud</h2>
            <p style="color:var(--text-light);margin-bottom:15px;font-size:0.9em">Valoraci√≥n media por tipo de residente (escala 1-10). Diferencias ‚â• 1 punto se resaltan con ‚¨ÜÔ∏è‚¨áÔ∏è</p>
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="background:var(--bg)">
                            <th style="text-align:left;padding:10px;font-weight:600">Condici√≥n</th>
                            <th style="text-align:center;padding:10px;color:#2c5282;font-weight:600">MIR</th>
                            <th style="text-align:center;padding:10px;color:#ed8936;font-weight:600">EIR</th>
                            <th style="text-align:center;padding:10px;font-weight:600">Dif.</th>
                        </tr>
                    </thead>
                    <tbody>${elementosHtml}</tbody>
                </table>
            </div>
        </div>
        <div class="card"><div style="background:#f0f4f8;border-radius:10px;padding:15px;font-size:0.9em;line-height:1.6">
            <strong>üìù An√°lisis:</strong> Muestra: ${mir.length} MIR y ${eir.length} EIR. 
            ${(() => {
                const diffs = indicadores.map(ind => {
                    const mMir = calcMediaGrupo(mir, ind.key);
                    const mEir = calcMediaGrupo(eir, ind.key);
                    return { label: ind.label, diff: mMir - mEir };
                }).filter(d => Math.abs(d.diff) >= 0.3);
                if (diffs.length === 0) return 'Las diferencias observadas entre MIR y EIR son inferiores a 0.3 puntos en todos los indicadores.';
                return 'Diferencias observadas ‚â•0.3 puntos: ' + diffs.map(d => `${d.label} (${d.diff > 0 ? 'MIR' : 'EIR'} +${Math.abs(d.diff).toFixed(1)})`).join(', ') + '.';
            })()}
        </div></div>
    `;
}

// ==================== AN√ÅLISIS POR SEXO ====================
function renderResultsSexo() {
    const hombres = responses.filter(r => r.sexo == 1);
    const mujeres = responses.filter(r => r.sexo == 2);
    const nH = hombres.length || 1;
    const nM = mujeres.length || 1;
    
    function calcMediaGrupo(arr, field) {
        const v = arr.map(r => parseFloat(r[field])).filter(x => x && !isNaN(x));
        return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
    }
    
    const hMir = hombres.filter(r => r.tipo_residente == 1).length;
    const hEir = hombres.filter(r => r.tipo_residente == 2).length;
    const mMir = mujeres.filter(r => r.tipo_residente == 1).length;
    const mEir = mujeres.filter(r => r.tipo_residente == 2).length;
    
    const indicadores = [
        { key: 'participacion_promocion', label: 'Participaci√≥n en promoci√≥n de la salud' },
        { key: 'valoracion_formacion', label: 'Valoraci√≥n formaci√≥n Grado' },
        { key: 'valoracion_formacion_2', label: 'Valoraci√≥n formaci√≥n Residencia' },
        { key: 'aplicabilidad_formacion', label: 'Aplicabilidad de la formaci√≥n' }
    ];
    
    let comparativaHtml = indicadores.map(ind => {
        const mediaH = calcMediaGrupo(hombres, ind.key);
        const mediaM = calcMediaGrupo(mujeres, ind.key);
        const diff = mediaH - mediaM;
        const diffIcon = Math.abs(diff) >= 0.5 ? (diff > 0 ? '‚¨ÜÔ∏è' : '‚¨áÔ∏è') : '‚ûñ';
        return `<tr>
            <td style="text-align:left;padding:10px;font-size:0.9em">${ind.label}</td>
            <td style="text-align:center;padding:10px;font-weight:700;color:#2c5282">${mediaH.toFixed(2)}</td>
            <td style="text-align:center;padding:10px;font-weight:700;color:#e53e3e">${mediaM.toFixed(2)}</td>
            <td style="text-align:center;padding:10px">${diffIcon}</td>
        </tr>`;
    }).join('');
    
    document.getElementById('resultsSexo').innerHTML = `
        <div class="card">
            <h2>üë©‚Äç‚öïÔ∏è Distribuci√≥n MIR/EIR por Sexo</h2>
            <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:20px;text-align:center">
                <div>
                    <div style="font-size:2.5em;margin-bottom:5px">üë®</div>
                    <div style="font-size:1.1em;font-weight:600;color:#2c5282">Hombres (n=${hombres.length})</div>
                    <div style="margin-top:10px">
                        <span style="background:#2c5282;color:white;padding:5px 12px;border-radius:15px;font-size:0.85em;margin:3px">MIR: ${hMir}</span>
                        <span style="background:#ed8936;color:white;padding:5px 12px;border-radius:15px;font-size:0.85em;margin:3px">EIR: ${hEir}</span>
                    </div>
                </div>
                <div>
                    <div style="font-size:2.5em;margin-bottom:5px">üë©</div>
                    <div style="font-size:1.1em;font-weight:600;color:#e53e3e">Mujeres (n=${mujeres.length})</div>
                    <div style="margin-top:10px">
                        <span style="background:#2c5282;color:white;padding:5px 12px;border-radius:15px;font-size:0.85em;margin:3px">MIR: ${mMir}</span>
                        <span style="background:#ed8936;color:white;padding:5px 12px;border-radius:15px;font-size:0.85em;margin:3px">EIR: ${mEir}</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>üìä Indicadores principales por Sexo</h2>
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="background:var(--bg)">
                            <th style="text-align:left;padding:12px">Indicador</th>
                            <th style="text-align:center;padding:12px;color:#2c5282">üë® Hombres</th>
                            <th style="text-align:center;padding:12px;color:#e53e3e">üë© Mujeres</th>
                            <th style="text-align:center;padding:12px">Dif.</th>
                        </tr>
                    </thead>
                    <tbody>${comparativaHtml}</tbody>
                </table>
            </div>
        </div>
        <div class="card"><div style="background:#f0f4f8;border-radius:10px;padding:15px;font-size:0.9em;line-height:1.6">
            <strong>üìù An√°lisis:</strong> Muestra: ${hombres.length} hombres y ${mujeres.length} mujeres. 
            ${(() => {
                const diffs = indicadores.map(ind => {
                    const mH = calcMediaGrupo(hombres, ind.key);
                    const mM = calcMediaGrupo(mujeres, ind.key);
                    return { label: ind.label, diff: mH - mM };
                }).filter(d => Math.abs(d.diff) >= 0.3);
                if (diffs.length === 0) return 'Las diferencias observadas entre hombres y mujeres son inferiores a 0.3 puntos en todos los indicadores.';
                return 'Diferencias observadas ‚â•0.3 puntos: ' + diffs.map(d => `${d.label} (${d.diff > 0 ? 'H' : 'M'} +${Math.abs(d.diff).toFixed(1)})`).join(', ') + '.';
            })()}
        </div></div>
    `;
}

// ==================== PERFIL DEL PROMOTOR ACTIVO ====================
function renderResultsPromotor() {
    const n = responses.length || 1;
    const promotoresActivos = responses.filter(r => parseFloat(r.participacion_promocion) >= 4);
    const noPromotores = responses.filter(r => parseFloat(r.participacion_promocion) < 4);
    const nPA = promotoresActivos.length || 1;
    const nNP = noPromotores.length || 1;
    
    function calcMediaGrupo(arr, field) {
        const v = arr.map(r => parseFloat(r[field])).filter(x => x && !isNaN(x));
        return v.length ? v.reduce((a, b) => a + b, 0) / v.length : 0;
    }
    
    const paMir = promotoresActivos.filter(r => r.tipo_residente == 1).length;
    const paEir = promotoresActivos.filter(r => r.tipo_residente == 2).length;
    const paHombre = promotoresActivos.filter(r => r.sexo == 1).length;
    const paMujer = promotoresActivos.filter(r => r.sexo == 2).length;
    
    const elemKeys = Object.keys(LABELS.elementos_corto);
    let elemComparativa = elemKeys.map(key => {
        const mPA = calcMediaGrupo(promotoresActivos, key);
        const mNP = calcMediaGrupo(noPromotores, key);
        const diff = mPA - mNP;
        const color = diff >= 1.0 ? 'var(--success)' : (diff <= -1.0 ? 'var(--danger)' : 'var(--text-light)');
        return `<tr>
            <td style="padding:8px;font-size:0.85em">${LABELS.elementos_corto[key]}</td>
            <td style="text-align:center;padding:8px;font-weight:600;color:var(--success)">${mPA.toFixed(2)}</td>
            <td style="text-align:center;padding:8px;font-weight:600;color:var(--text-light)">${mNP.toFixed(2)}</td>
            <td style="text-align:center;padding:8px;font-weight:600;color:${color}">${diff >= 0 ? '+' : ''}${diff.toFixed(2)}</td>
        </tr>`;
    }).join('');
    
    document.getElementById('resultsPromotor').innerHTML = `
        <div class="card">
            <h2>üèÜ Perfil del Promotor Activo</h2>
            <div style="background:#e6fffa;border-left:4px solid var(--success);padding:15px;margin-bottom:20px;border-radius:0 8px 8px 0">
                <p style="margin:0 0 10px 0;font-weight:600;color:#276749">üìå ¬øC√≥mo se clasifican los residentes?</p>
                <p style="margin:0 0 8px 0;font-size:0.9em;color:#234e52"><strong>Promotor activo:</strong> Residente que responde "A menudo" o "Siempre" (puntuaci√≥n ‚â• 4) a la pregunta sobre su participaci√≥n en actividades de promoci√≥n de la salud.</p>
                <p style="margin:0;font-size:0.9em;color:#234e52"><strong>No promotor:</strong> Residente que responde "Nunca", "Casi nunca" o "A veces" (puntuaci√≥n < 4) a la misma pregunta.</p>
            </div>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px;margin:20px 0">
                <div style="background:linear-gradient(135deg,var(--success),#276749);color:white;padding:20px;border-radius:12px;text-align:center">
                    <div style="font-size:2.5em;font-weight:700">${promotoresActivos.length}</div>
                    <div style="font-size:0.9em;opacity:0.9">Promotores activos</div>
                    <div style="font-size:0.8em;opacity:0.7">${(promotoresActivos.length/n*100).toFixed(0)}% del total</div>
                </div>
                <div style="background:linear-gradient(135deg,#718096,#4a5568);color:white;padding:20px;border-radius:12px;text-align:center">
                    <div style="font-size:2.5em;font-weight:700">${noPromotores.length}</div>
                    <div style="font-size:0.9em;opacity:0.9">No promotores</div>
                    <div style="font-size:0.8em;opacity:0.7">${(noPromotores.length/n*100).toFixed(0)}% del total</div>
                </div>
            </div>
            <h3 style="margin:20px 0 10px;font-size:1em;color:var(--primary)">Composici√≥n de los promotores activos</h3>
            <div style="display:flex;flex-wrap:wrap;gap:10px">
                <span style="background:#2c5282;color:white;padding:8px 15px;border-radius:20px;font-size:0.85em">ü©∫ MIR: ${paMir}</span>
                <span style="background:#ed8936;color:white;padding:8px 15px;border-radius:20px;font-size:0.85em">üíâ EIR: ${paEir}</span>
                <span style="background:#2c5282;color:white;padding:8px 15px;border-radius:20px;font-size:0.85em">üë® Hombres: ${paHombre}</span>
                <span style="background:#e53e3e;color:white;padding:8px 15px;border-radius:20px;font-size:0.85em">üë© Mujeres: ${paMujer}</span>
            </div>
        </div>
        <div class="card">
            <h2>‚öôÔ∏è Comparativa: Promotores activos vs No promotores</h2>
            <p style="color:var(--text-light);margin-bottom:15px;font-size:0.9em">Valoraci√≥n media de cada condici√≥n de promoci√≥n de la salud (escala 1-10)</p>
            <div style="overflow-x:auto">
                <table style="width:100%;border-collapse:collapse">
                    <thead>
                        <tr style="background:var(--bg)">
                            <th style="text-align:left;padding:10px">Condici√≥n</th>
                            <th style="text-align:center;padding:10px;color:var(--success)">Promotores activos (n=${promotoresActivos.length})</th>
                            <th style="text-align:center;padding:10px;color:#718096">No promotores (n=${noPromotores.length})</th>
                            <th style="text-align:center;padding:10px">Diferencia</th>
                        </tr>
                    </thead>
                    <tbody>${elemComparativa}</tbody>
                </table>
            </div>
        </div>
        <div class="card"><div style="background:#f0f4f8;border-radius:10px;padding:15px;font-size:0.9em;line-height:1.6">
            <strong>üìù An√°lisis:</strong> ${promotoresActivos.length} de ${n} residentes (${(promotoresActivos.length/n*100).toFixed(0)}%) se clasifican como "promotores activos". 
            Composici√≥n: ${paMir} MIR (${(paMir/(paMir+paEir||1)*100).toFixed(0)}%) y ${paEir} EIR (${(paEir/(paMir+paEir||1)*100).toFixed(0)}%). 
            Por sexo: ${paHombre} hombres y ${paMujer} mujeres.
        </div></div>
    `;
}

// ==================== EXPORTAR ====================
function exportData() {
    if (responses.length === 0) { alert('No hay datos para exportar'); return; }
    const headers = Object.keys(responses[0]);
    let csv = headers.join(';') + '\n';
    responses.forEach(r => { csv += headers.map(h => r[h] ?? '').join(';') + '\n'; });
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'encuesta_mireir_' + new Date().toISOString().slice(0, 10) + '.csv';
    link.click();
}

// ==================== PDF CUESTIONARIO ====================
function generarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 20;
    const marginLeft = 15;
    const pageWidth = 210;
    const contentWidth = pageWidth - 30;
    
    function checkPage(needed) { if (y + needed > 280) { doc.addPage(); y = 20; } }
    
    function addTitle(text, size) {
        doc.setFontSize(size || 16);
        doc.setTextColor(26, 54, 93);
        doc.setFont('helvetica', 'bold');
        doc.text(text, pageWidth / 2, y, { align: 'center' });
        y += size ? size * 0.6 : 10;
    }
    
    function addSection(text) {
        checkPage(15);
        y += 3;
        doc.setFillColor(26, 54, 93);
        doc.rect(marginLeft, y - 5, contentWidth, 7, 'F');
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.text(text, marginLeft + 3, y);
        y += 8;
        doc.setTextColor(0, 0, 0);
    }
    
    function addSubsection(text) {
        checkPage(10);
        y += 2;
        doc.setFontSize(9);
        doc.setTextColor(26, 54, 93);
        doc.setFont('helvetica', 'bold');
        doc.text(text, marginLeft, y);
        y += 5;
        doc.setTextColor(0, 0, 0);
    }
    
    function addQuestion(label, note) {
        checkPage(10);
        doc.setFontSize(9);
        doc.setFont('helvetica', 'normal');
        const lines = doc.splitTextToSize(label, contentWidth);
        doc.text(lines, marginLeft, y);
        y += lines.length * 4;
        if (note) {
            doc.setFontSize(7);
            doc.setTextColor(100, 100, 100);
            doc.text(note, marginLeft, y);
            y += 3;
            doc.setTextColor(0, 0, 0);
        }
    }
    
    function addRadio(options) {
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        options.forEach(opt => {
            checkPage(5);
            doc.circle(marginLeft + 4, y - 1.2, 1.5);
            doc.text(opt, marginLeft + 8, y);
            y += 4;
        });
        y += 1;
    }
    
    function addCheckbox(options) {
        doc.setFontSize(8);
        doc.setFont('helvetica', 'normal');
        options.forEach(opt => {
            checkPage(5);
            doc.rect(marginLeft + 2.5, y - 3, 3, 3);
            doc.text(opt, marginLeft + 8, y);
            y += 4;
        });
        y += 1;
    }
    
    function addDropdownCompact(options) {
        doc.setFontSize(7);
        doc.setFont('helvetica', 'normal');
        const perLine = 3;
        const colW = contentWidth / perLine;
        for (let i = 0; i < options.length; i += perLine) {
            checkPage(4);
            for (let j = 0; j < perLine && i + j < options.length; j++) {
                doc.text(options[i + j], marginLeft + j * colW, y);
            }
            y += 3.5;
        }
        y += 2;
    }
    
    function addLikertMatrix(items, scaleLabels) {
        checkPage(8);
        const numOptions = scaleLabels.length;
        const optionsWidth = numOptions <= 5 ? 32 : 55;
        doc.setFontSize(7);
        doc.setFont('helvetica', 'italic');
        doc.setTextColor(100);
        if (numOptions <= 5) {
            doc.text(scaleLabels.join('  |  '), marginLeft, y);
        } else {
            doc.text('1 = Muy deficiente                                                      10 = Excelente', marginLeft, y);
        }
        y += 4;
        doc.setTextColor(0);
        doc.setFont('helvetica', 'normal');
        const optionsStr = scaleLabels.map((_, i) => 'O ' + (i + 1)).join('  ');
        items.forEach(item => {
            checkPage(6);
            const lines = doc.splitTextToSize(item, contentWidth - optionsWidth - 5);
            doc.text(lines, marginLeft, y);
            doc.setFontSize(6);
            doc.text(optionsStr, marginLeft + contentWidth - optionsWidth, y);
            doc.setFontSize(7);
            y += Math.max(lines.length * 3.5, 4);
        });
        y += 2;
    }
    
    function addTextField() {
        doc.setDrawColor(150);
        doc.line(marginLeft, y, marginLeft + contentWidth, y);
        y += 5;
    }
    
    // === PORTADA ===
    y = 50;
    addTitle('CUESTIONARIO MIR/EIR', 18);
    y += 3;
    addTitle('Promoci√≥n de la Salud en Atenci√≥n Primaria', 12);
    y += 8;
    doc.setFontSize(10);
    doc.setFont('helvetica', 'normal');
    doc.setTextColor(100);
    doc.text('Distritos Granada y Metropolitano de Granada', pageWidth / 2, y, { align: 'center' });
    doc.setTextColor(0);
    
    // === DATOS SOCIODEMOGR√ÅFICOS ===
    doc.addPage(); y = 20;
    addSection('DATOS SOCIODEMOGR√ÅFICOS');
    
    addSubsection('Datos sociodemogr√°ficos');
    addQuestion('Sexo');
    addRadio(['1. Hombre', '2. Mujer', '3. Otro', '4. Prefiero no contestar']);
    
    addQuestion('Edad (a√±os)', 'Indica tu edad en a√±os');
    addTextField();
    
    addSubsection('Datos de residencia');
    addQuestion('Tipo de residente');
    addRadio(['1. MIR (Medicina familiar y comunitaria)', '2. EIR (Enfermer√≠a familiar y comunitaria)']);
    
    addQuestion('A√±o de residencia MIR', 'Mostrar si tipo = MIR');
    addRadio(['1. R1 (Primer a√±o)', '2. R2 (Segundo a√±o)', '3. R3 (Tercer a√±o)', '4. R4 (Cuarto a√±o)']);
    
    addQuestion('A√±o de residencia EIR', 'Mostrar si tipo = EIR');
    addRadio(['1. R1 (Primer a√±o)', '2. R2 (Segundo a√±o)']);
    
    addSubsection('Unidad de Gesti√≥n Cl√≠nica');
    addQuestion('Distrito');
    addRadio(['0. Granada', '1. Metropolitano de Granada']);
    
    addQuestion('Unidad de Gesti√≥n Cl√≠nica (Granada)', 'Mostrar si distrito = Granada');
    addDropdownCompact(['1. Albayz√≠n', '2. Almanj√°yar', '3. Bola de Oro', '4. Caleta', '5. Cartuja', '6. Caser√≠a de Montijo', '7. Chana', '8. Doctores', '9. Flores-F√≠gares', '10. Fortuny/Velluti', '11. G√≥ngora', '12. Gran Capit√°n', '13. Realejo', '14. Zaid√≠n Centro-Este', '15. Zaid√≠n Sur']);
    
    addQuestion('Unidad de Gesti√≥n Cl√≠nica (Metropolitano)', 'Mostrar si distrito = Metropolitano');
    addDropdownCompact(['1. Albolote', '2. Alfacar', '3. Alhama de Granada', '4. Armilla', '5. Atarfe', '6. Cenes de la Vega', '7. Churriana de la Vega', '8. Hu√©tor-T√°jar', '9. Hu√©tor-Vega', '10. √çllora', '11. Iznalloz', '12. La Zubia', '13. Las Gabias', '14. Loja', '15. Maracena', '16. Montefr√≠o', '17. Og√≠jares', '18. Peligros', '19. Pinos Puente', '20. Santa Fe', '21. Valle de Lecr√≠n']);
    
    // === FORMACI√ìN ===
    doc.addPage(); y = 20;
    addSection('FORMACI√ìN EN PROMOCI√ìN DE LA SALUD');
    
    addSubsection('Participaci√≥n en actividades de promoci√≥n de la salud');
    addQuestion('Indica con qu√© frecuencia participas en actividades de promoci√≥n de la salud en tu Unidad de Gesti√≥n Cl√≠nica');
    addRadio(['1. Nunca', '2. Casi nunca', '3. A veces', '4. A menudo', '5. Siempre']);
    
    addSubsection('Valoraci√≥n de la formaci√≥n recibida');
    addQuestion('Valora la calidad de la formaci√≥n en promoci√≥n de la salud que recibiste durante el per√≠odo de formaci√≥n de Grado');
    addRadio(['1. Muy deficiente', '2. Deficiente', '3. Aceptable', '4. Buena', '5. Excelente']);
    
    addQuestion('Valora la calidad de la formaci√≥n en promoci√≥n de la salud que has recibido hasta el momento durante tu residencia');
    addRadio(['1. Muy deficiente', '2. Deficiente', '3. Aceptable', '4. Buena', '5. Excelente']);
    
    addQuestion('Valora en qu√© medida la formaci√≥n recibida hasta el momento en promoci√≥n de la salud es aplicable a tu pr√°ctica profesional');
    addRadio(['1. Totalmente insuficiente', '2. Insuficiente', '3. Adecuada', '4. Suficiente', '5. Totalmente suficiente']);
    
    addSubsection('Necesidades formativas');
    addQuestion('Selecciona todas aquellas tem√°ticas relacionadas con la promoci√≥n de la salud sobre las cuales te gustar√≠a recibir formaci√≥n');
    addCheckbox(['1. Dise√±o, planificaci√≥n y evaluaci√≥n de intervenciones de promoci√≥n de la salud', '2. Competencias y habilidades para la intervenci√≥n grupal en promoci√≥n de la salud', '3. Estrategias, planes y programas de promoci√≥n de la salud en mi centro', '4. M√©todos y t√©cnicas cuantitativas y cualitativas de investigaci√≥n, participaci√≥n y acci√≥n en promoci√≥n de la salud', '5. Otras']);
    
    addQuestion('Especifique otras tem√°ticas de inter√©s', 'Mostrar si marc√≥ "Otras"');
    addTextField();
    
    addSubsection('Disponibilidad y preferencias');
    addQuestion('Selecciona tu disponibilidad horaria para recibir formaci√≥n');
    addCheckbox(['1. En horario laboral', '2. Por las tardes', '3. En horario flexible seg√∫n disponibilidad']);
    
    addQuestion('Indica qu√© modalidad de formaci√≥n prefieres');
    addRadio(['1. Presencial', '2. Online', '3. Mixta (presencial y online)']);
    
    doc.addPage(); y = 20;
    addSubsection('Objetivos estrat√©gicos de la Estrategia de Promoci√≥n de una Vida Saludable en Andaluc√≠a (EPVSA)');
    addQuestion('Selecciona de entre los siguientes el objetivo que sea de mayor inter√©s para ti');
    addRadio(['1. Incrementar los niveles de lactancia materna y el consumo de alimentos saludables', '2. Aumentar los niveles de actividad f√≠sica y disminuir los h√°bitos sedentarios', '3. Incrementar las horas y la calidad del sue√±o en la poblaci√≥n', '4. Incrementar la percepci√≥n de calidad de vida y de bienestar emocional', '5. Incrementar la percepci√≥n de satisfacci√≥n con las relaciones sexuales', '6. Disminuir el tiempo dedicado al uso de aparatos electr√≥nicos', '7. Incrementar las recomendaciones sobre activos comunitarios', '8. Incrementar el n√∫mero de empresas comprometidas con h√°bitos saludables', '9. Incrementar y favorecer la difusi√≥n de informaci√≥n sobre h√°bitos saludables', '10. Incrementar la formaci√≥n y la investigaci√≥n en promoci√≥n de h√°bitos saludables']);
    
    // === ASPECTOS PROMOCI√ìN DE LA SALUD ===
    doc.addPage(); y = 20;
    addSection('CONDICIONES PARA TU INTERVENCI√ìN EN PROMOCI√ìN DE LA SALUD');
    addQuestion('Valora las distintas condiciones relacionadas con la promoci√≥n de la salud durante tu tiempo de residencia en un centro de Atenci√≥n Primaria');
    addLikertMatrix([
        'Existe una cultura favorable a la promoci√≥n de la salud en Atenci√≥n Primaria',
        'Dispongo de tiempo suficiente en mi agenda para actividades de promoci√≥n de la salud',
        'Cuento con las habilidades y competencias necesarias para desarrollar actividades de promoci√≥n de la salud',
        'Dispongo de espacios adecuados para realizar intervenciones de promoci√≥n de la salud',
        'Dispongo de materiales y recursos suficientes para las intervenciones',
        'Tengo acceso adecuado a la poblaci√≥n diana para las intervenciones',
        'Existe buena colaboraci√≥n con otros profesionales para desarrollar actividades de promoci√≥n de la salud',
        'Cuento con recursos pedag√≥gicos y materiales did√°cticos adecuados',
        'El plan de formaci√≥n docente responde a mis necesidades en materia de promoci√≥n de la salud',
        'Mi tutor/a facilita y apoya el desarrollo de actividades de promoci√≥n de la salud'
    ], ['1', '2', '3', '4', '5', '6', '7', '8', '9', '10']);
    
    // === DIAGN√ìSTICO ===
    doc.addPage(); y = 20;
    addSection('DIAGN√ìSTICO COMUNITARIO');
    addQuestion('Indica tu grado de acuerdo con las siguientes afirmaciones');
    addLikertMatrix([
        'Conozco las caracter√≠sticas sociodemogr√°ficas de la poblaci√≥n de referencia de mi UGC',
        'Conozco la situaci√≥n de salud (morbimortalidad) de la poblaci√≥n de referencia de mi UGC',
        'Conozco los objetivos de promoci√≥n de la salud incluidos en los acuerdos de gesti√≥n de mi UGC'
    ], ['1-Muy en desacuerdo', '2-En desacuerdo', '3-Ni acuerdo/desacuerdo', '4-De acuerdo', '5-Muy de acuerdo']);
    
    addSubsection('Colaboraci√≥n en promoci√≥n de la salud');
    addQuestion('Indica con cu√°l o cu√°les de las siguientes organizaciones has colaborado en promoci√≥n de la salud');
    addCheckbox(['1. Administraci√≥n auton√≥mica presente en el territorio', '2. Administraci√≥n local (Ayuntamiento, Mancomunidad, Diputaci√≥n)', '3. Tejido social (Asociaciones de familiares, de pacientes, ONGs...)', '4. Centros de Participaci√≥n Activa (auton√≥micos y municipales)', '5. Centros de Educaci√≥n de Adultos', '6. Puntos Vuela', '7. Centros educativos']);
    
    addQuestion('En el caso de haberlo hecho, ¬øcon qu√© profesionales has colaborado en promoci√≥n de la salud?');
    addCheckbox(['1. Director/a de la UGC', '2. Coordinador/a de Cuidados de Enfermer√≠a', '3. Profesionales de Medicina Familiar y Comunitaria (MFYC)', '4. Profesionales de Enfermer√≠a Familiar y Comunitaria (EFYC)', '5. Profesionales de Enfermer√≠a Referente de Centro Educativo (ERCE)', '6. Profesionales de Trabajo Social (TS)', '7. Profesionales de Fisioterapia', '8. Profesionales de Terapia Ocupacional (TO)', '9. Profesionales de la Enfermer√≠a Gestora de Casos', '10. Profesionales del Dispositivo de Cuidados Cr√≠ticos y Urgencias (DDCCUU)', '11. Profesionales de Pediatr√≠a']);
    
    addQuestion('¬øHay alguna otra cosa sobre la cual no te hayamos preguntado y sobre la cual te gustar√≠a comentar algo?');
    doc.setDrawColor(150);
    for (let i = 0; i < 4; i++) { y += 6; doc.line(marginLeft, y, marginLeft + contentWidth, y); }
    y += 4;
    
    // Final
    y += 15;
    checkPage(20);
    doc.setFontSize(12);
    doc.setTextColor(26, 54, 93);
    doc.setFont('helvetica', 'bold');
    doc.text('¬°Gracias por tu participaci√≥n!', pageWidth / 2, y, { align: 'center' });
    
    doc.save('cuestionario_mireir_2025.pdf');
}

// ==================== SIMULACI√ìN ====================
function simularDatos() {
    if (!sessionId) {
        alert('Primero inicia una sesi√≥n');
        return;
    }
    if (!confirm('¬øGenerar 100 respuestas simuladas?')) return;
    
    const ugcGranada = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15];
    const ugcMetro = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21];
    
    let count = 0;
    const interval = setInterval(() => {
        if (count >= 100) {
            clearInterval(interval);
            alert('‚úÖ 100 respuestas simuladas generadas');
            return;
        }
        
        // 70% MIR, 30% EIR
        const esMir = Math.random() < 0.7;
        const tipo = esMir ? 1 : 2;
        const anioMir = esMir ? Math.floor(Math.random() * 4) + 1 : null;
        const anioEir = !esMir ? Math.floor(Math.random() * 2) + 1 : null;
        const distrito = Math.random() < 0.5 ? 0 : 1;
        
        const data = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            timestamp: Date.now(),
            sexo: Math.floor(Math.random() * 4) + 1,
            edad: Math.floor(Math.random() * 15) + 25,
            tipo_residente: tipo,
            anio_residencia_mir: anioMir,
            anio_residencia_eir: anioEir,
            distrito: distrito,
            ugc_granada: distrito === 0 ? ugcGranada[Math.floor(Math.random() * ugcGranada.length)] : null,
            ugc_metropolitano: distrito === 1 ? ugcMetro[Math.floor(Math.random() * ugcMetro.length)] : null,
            participacion_promocion: Math.floor(Math.random() * 5) + 1,
            valoracion_formacion: Math.floor(Math.random() * 5) + 1,
            valoracion_formacion_2: Math.floor(Math.random() * 5) + 1,
            aplicabilidad_formacion: Math.floor(Math.random() * 5) + 1,
            modalidad_formacion: Math.floor(Math.random() * 3) + 1,
            objetivo_epvsa: Math.floor(Math.random() * 10) + 1,
            elem_cultura: Math.floor(Math.random() * 10) + 1,
            elem_tiempo: Math.floor(Math.random() * 10) + 1,
            elem_habilidades: Math.floor(Math.random() * 10) + 1,
            elem_espacios: Math.floor(Math.random() * 10) + 1,
            elem_materiales: Math.floor(Math.random() * 10) + 1,
            elem_acceso: Math.floor(Math.random() * 10) + 1,
            elem_colaboracion: Math.floor(Math.random() * 10) + 1,
            elem_recursos_ped: Math.floor(Math.random() * 10) + 1,
            elem_plan_formacion: Math.floor(Math.random() * 10) + 1,
            elem_tutor: Math.floor(Math.random() * 10) + 1,
            diag_caract_poblacion: Math.floor(Math.random() * 5) + 1,
            diag_morbimortalidad: Math.floor(Math.random() * 5) + 1,
            diag_objetivos: Math.floor(Math.random() * 5) + 1
        };
        
        // Checkboxes aleatorios
        for (let i = 1; i <= 5; i++) data['tematicas_formacion___' + i] = Math.random() < 0.3 ? 1 : 0;
        for (let i = 1; i <= 3; i++) data['disponibilidad_horaria___' + i] = Math.random() < 0.4 ? 1 : 0;
        for (let i = 1; i <= 7; i++) data['colaboracion_externa___' + i] = Math.random() < 0.4 ? 1 : 0;
        for (let i = 1; i <= 11; i++) data['colaboracion_profesionales___' + i] = Math.random() < 0.5 ? 1 : 0;
        
        db.ref('encuestas_mireir/' + sessionId + '/responses').push(data);
        count++;
    }, 100);
}
</script>
</body>
</html>
